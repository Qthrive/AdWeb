 # AdWeb 广告管理平台 - 系统图表文档

本文档提供 AdWeb 广告管理平台的各种图表和可视化内容，用于辅助理解系统的设计和实现。

## 1. 用例图

用例图展示了系统的主要功能和不同角色的交互关系。

```plantuml
@startuml GlobalUseCases
left to right direction
title AdWeb 平台全局用例图

actor "广告主 (Advertiser)" as Advertiser
actor "管理员 (Administrator)" as Admin
actor "系统 (System)" as SystemUser #APPLICATION

rectangle "AdWeb 广告管理平台" {
  Advertiser -- (用户注册)
  Advertiser -- (用户登录)
  Advertiser -- (账户管理)
  Advertiser -- (广告活动管理)
  Advertiser -- (广告管理)
  Advertiser -- (查看广告数据)
  Advertiser -- (财务管理)
  Advertiser -- (发票管理)

  Admin -- (用户登录)
  Admin -- (用户审核)
  Admin -- (广告审核)
  Admin -- (广告位管理)
  Admin -- (系统数据报表)
  Admin -- (财务审批)
  Admin -- (发票审批)
  Admin -- (系统配置)
  
  SystemUser -- (发送通知)
  SystemUser -- (生成统计报表)
  SystemUser -- (执行定时任务)
}
@enduml
```

### 1.1 核心模块用例图

#### 1.1.1 用户管理模块 (User Management)

```plantuml
@startuml UserManagementUseCases
title 用户管理模块用例图
left to right direction
actor "广告主" as Advertiser
actor "管理员" as Admin

rectangle "用户管理" {
  Advertiser -- (UUC01: 注册账户)
  Advertiser -- (UUC02: 登录系统)
  Advertiser -- (UUC03: 修改个人资料)
  Advertiser -- (UUC04: 修改密码)
  Advertiser -- (UUC05: 查看账户余额)
  Advertiser -- (UUC06: 查看通知)
  Advertiser -- (UUC07: 申请密码重置)
  Advertiser -- (UUC08: 邮箱验证)

  Admin -- (UUC02: 登录系统)
  Admin -- (UAC01: 审核用户注册)
  Admin -- (UAC02: 管理用户信息)
  Admin -- (UAC03: 查看用户列表)
  Admin -- (UAC04: 发送系统通知给用户)
  Admin -- (UAC05: 禁用/启用用户账户)
}

(UAC01) .> (UAC04) : <<include>>
(UAC02) ..> (UAC03) : <<extend>>
(UUC01) ..> (UUC08) : <<extend>>
@enduml
```

#### 1.1.2 广告管理模块 (Advertisement Management)

```plantuml
@startuml AdManagementUseCases
title 广告管理模块用例图
left to right direction
actor "广告主" as Advertiser
actor "管理员" as Admin

rectangle "广告管理" {
  Advertiser -- (ADUC01: 创建广告活动)
  Advertiser -- (ADUC02: 管理广告活动)
  Advertiser -- (ADUC03: 创建广告)
  Advertiser -- (ADUC04: 编辑广告内容)
  Advertiser -- (ADUC05: 提交广告审核)
  Advertiser -- (ADUC06: 查看广告状态)
  Advertiser -- (ADUC07: 查看广告数据)
  Advertiser -- (ADUC08: 上传广告素材)
  Advertiser -- (ADUC09: 暂停/启动广告)
  Advertiser -- (ADUC10: 复制广告)

  Admin -- (ADAC01: 审核广告内容)
  Admin -- (ADAC02: 管理广告位)
  Admin -- (ADAC03: 查看所有广告)
  Admin -- (ADAC04: 设置广告参数)
  Admin -- (ADAC05: 管理广告分类/标签)
}

(ADUC03) --|> (ADUC01) : extends
(ADUC05) .> (ADAC01) : triggers
(ADUC07) ..> (生成数据报表) : <<extend>>
(ADUC03) ..> (ADUC08) : <<include>>
@enduml
```

#### 1.1.3 财务与发票管理模块 (Finance & Invoice Management)

```plantuml
@startuml FinanceInvoiceUseCases
title 财务与发票管理模块用例图
left to right direction
actor "广告主" as Advertiser
actor "管理员" as Admin

rectangle "财务与发票管理" {
  Advertiser -- (FIUC01: 账户充值)
  Advertiser -- (FIUC02: 查看交易记录)
  Advertiser -- (FIUC03: 申请发票)
  Advertiser -- (FIUC04: 管理发票信息)
  Advertiser -- (FIUC05: 查看发票状态)
  Advertiser -- (FIUC06: 取消发票申请)
  Advertiser -- (FIUC07: 下载电子发票)
  Advertiser -- (FIUC08: 设置默认发票抬头)

  Admin -- (FIAC01: 审核充值记录)
  Admin -- (FIAC02: 处理发票申请)
  Admin -- (FIAC03: 标记发票状态)
  Admin -- (FIAC04: 查看系统财务报表)
  Admin -- (FIAC05: 导出交易数据)
  Admin -- (FIAC06: 处理退款申请)
}

(FIUC03) ..> (FIUC04) : <<include>>
(FIAC02) .> (FIAC03) : <<include>>
(FIAC03) ..> (FIUC07) : <<extend>>  : (若为电子发票且开具完成)
@enduml
```

### 1.2 详细用例描述 (表格形式)

#### 广告主用例

| 用例ID | 用例名称     | 参与者 | 优先级 | 前置条件                                     | 基本事件流 (用户操作与系统响应)                                                                                                                                                              | 后置条件                                                                 | 扩展/替代流程                                                                                                                                                                                             | 备注                                      |
|--------|--------------|--------|--------|----------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
| UUC01  | 用户注册     | 广告主 | 高     | 无                                           | 1. 用户访问注册页面。 <br> 2. 系统显示注册表单（用户名、邮箱、密码等）。 <br> 3. 用户填写信息并提交。 <br> 4. 系统校验数据。 <br> 5. 系统创建用户账户（状态：待审核），发送验证邮件（可选）。 <br> 6. 系统提示注册请求已提交，等待审核/邮箱验证。 | 用户账户被创建，状态为"待审核"或"待邮箱验证"。                              | 4a. 数据校验失败：系统提示错误信息。 <br> 5a. 邮箱已被注册：系统提示邮箱已存在。                                                                                                                            | 对应 `User` audit_status='pending'         |
| ADUC01 | 创建广告活动 | 广告主 | 高     | 用户已登录，账户状态正常。                   | 1. 用户进入广告活动管理界面，点击"创建新活动"。 <br> 2. 系统展示活动创建表单（名称、总预算、每日预算、投放起止日期等）。 <br> 3. 用户填写表单并提交。 <br> 4. 系统校验数据。 <br> 5. 系统创建广告活动（状态：待审核/草稿/进行中）。 <br> 6. 系统提示活动创建成功。 | 新广告活动被创建。                                                         | 4a. 数据校验失败：系统提示错误。                                                                                                                                                                            | Campaign status: pending_approval / active |
| ADUC03 | 创建广告     | 广告主 | 高     | 用户已登录，已存在有效的广告活动。             | 1. 用户在指定广告活动下点击"创建广告"。 <br> 2. 系统展示广告创建表单（名称、广告位、预算、素材、目标URL、投放时段等）。 <br> 3. 用户填写信息，上传素材并提交。 <br> 4. 系统校验数据。 <br> 5. 系统创建广告（状态：待审核）。<br> 6. 系统提示广告提交成功，等待审核。 | 新广告被创建，状态为"待审核"。                                               | 3a. 素材上传失败：系统提示错误。 <br> 4a. 数据校验失败（如预算超限）：系统提示错误。                                                                                                                             | Ad status: 'pending_approval'            |
| FIUC01 | 账户充值     | 广告主 | 高     | 用户已登录。                                 | 1. 用户进入充值页面。 <br> 2. 系统显示充值选项（金额、支付方式）。 <br> 3. 用户选择/输入充值金额和支付方式并提交。 <br> 4. 系统跳转至支付网关（模拟）或处理余额支付。 <br> 5. 支付成功后，系统更新用户余额，创建交易记录。 <br> 6. 系统提示充值成功，发送通知。 | 用户账户余额增加，生成"充值"类型交易记录。                                   | 4a. 支付失败：系统提示支付失败。 <br> 5a. 充值金额无效：系统提示错误。                                                                                                                                            | Transaction type: 'recharge'               |
| FIUC03 | 申请发票     | 广告主 | 中     | 用户已登录，有可开票交易记录，已设置发票抬头。 | 1. 用户进入发票管理，点击"申请发票"。 <br> 2. 系统显示可开票金额和交易，用户选择发票抬头、填写发票金额、接收邮箱等。 <br> 3. 用户提交申请。 <br> 4. 系统校验数据。 <br> 5. 系统创建发票申请记录（状态：待处理），关联交易项。 <br> 6. 系统提示申请已提交。 | 新发票申请被创建，状态为"待处理"。                                           | 2a. 无可用发票抬头：引导用户创建。 <br> 4a. 申请金额超过可开票金额：系统提示错误。                                                                                                                                     | Invoice status: 'pending'                  |

#### 管理员用例

| 用例ID | 用例名称     | 参与者 | 优先级 | 前置条件                       | 基本事件流 (用户操作与系统响应)                                                                                                                                                            | 后置条件                                                         | 扩展/替代流程                                                                                               | 备注                                                        |
|--------|--------------|--------|--------|--------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|
| UAC01  | 审核用户注册 | 管理员 | 高     | 管理员已登录，存在待审核用户。 | 1. 管理员查看待审核用户列表。 <br> 2. 管理员选择用户进行审核。 <br> 3. 系统展示用户注册信息。 <br> 4. 管理员操作"批准"或"拒绝"。 <br> 5. 系统更新用户审核状态，发送通知给用户。 <br> 6. 系统记录审核日志。 | 用户审核状态更新为"已批准"或"已拒绝"。                               | 4a. 需补充材料：管理员可发送通知要求用户补充。                                                                | User audit_status: 'approved' / 'rejected'                |
| ADAC01 | 审核广告内容 | 管理员 | 高     | 管理员已登录，存在待审核广告。 | 1. 管理员查看待审核广告列表。 <br> 2. 管理员选择广告进行审核。 <br> 3. 系统展示广告详情和素材。 <br> 4. 管理员操作"批准"或"拒绝"（可附带原因）。 <br> 5. 系统更新广告状态，记录审核日志，发送通知给广告主。 | 广告状态更新为"投放中"或"已拒绝"。                                   | 4a. 广告内容违规：管理员可直接拒绝。 <br> 4b. 广告素材不清晰：管理员可要求重新上传。                             | Ad status: 'active' / 'rejected', 创建 AuditLog              |
| FIAC02 | 处理发票申请 | 管理员 | 中     | 管理员已登录，存在待处理发票。 | 1. 管理员查看待处理发票列表。 <br> 2. 管理员选择发票进行处理。 <br> 3. 系统展示发票申请详情和关联交易。 <br> 4. 管理员操作"批准处理"、"拒绝"或"标记已开具"。 <br> 5. 系统更新发票状态，发送通知给用户。        | 发票状态更新（processing, rejected, completed）。                 | 4a. 信息不符：管理员可拒绝并说明原因。 <br> 4b. 若选择"标记已开具"，需填写发票号、日期等。                    | Invoice status: 'processing', 'rejected', 'completed'     |

## 2. 参与者类属关系图

参与者类属关系图展示了系统中不同角色的层次关系。`User` 是基类，`Advertiser` 和 `Administrator` 是其具体化。

```plantuml
@startuml
skinparam monochrome true
' 使用类图而非参与者图，更适合展示类属性和继承关系
class User {
  - username
  - email
  - password (hashed)
  - is_active
  - user_type
  - balance
  - audit_status
}

class Advertiser {
  - company_name
  - phone_number
}

class Administrator {
  - admin_privileges
  - can_audit_users
  - can_audit_ads
  - can_manage_invoices
}

' 继承关系（类图中 <|-- 表示泛化/继承）
User <|-- Advertiser
User <|-- Administrator
@enduml
```

### 2.1 参与者特性描述

#### User（用户抽象基类）
所有系统用户的基类，包含共有属性和方法：
- **属性**: `username`, `email`, `password` (加密存储), `is_active` (账户是否激活), `user_type` (用户类型: advertiser, admin), `date_joined` (注册时间), `last_login` (最后登录时间), `first_name`, `last_name`。
- **通用方法**: `login()`, `logout()`, `update_profile()`, `change_password()`。

#### Advertiser（广告主）
继承自User，代表使用平台投放广告的客户。
- **特有属性**: `company_name`, `phone_number` (联系方式), `balance` (账户余额), `audit_status` (账户审核状态: pending, approved, rejected)。
- **主要职责/方法**: 管理账户、创建和管理广告活动 (`create_campaign()`)与广告 (`create_ad()`)、账户充值 (`recharge_account()`)、申请发票 (`request_invoice()`)、查看广告数据。

#### Administrator（管理员）
继承自User，代表管理和维护平台的内部人员。
- **特有属性**: `is_staff` (固定为true), `is_superuser` (最高权限)。
- **主要职责/方法**: 审核用户注册 (`audit_user()`)、审核广告内容 (`audit_ad()`)、管理广告位 (`manage_ad_placement()`)、处理发票申请 (`process_invoice()`)、查看系统报表 (`view_system_reports()`)、管理用户账户。

#### System（系统参与者）
代表系统自身执行的一些自动化或后台处理功能，非人类用户。
- **主要职责/方法**: 发送各类通知 (`send_notification()`)、自动生成统计报表 (`generate_reports()`)、执行定时任务 (`run_scheduled_tasks()`，如每日数据汇总、活动状态更新)、记录系统活动日志 (`log_activity()`)。


## 3. 数据库设计

### 3.1 实体关系图 (ERD - Enhanced Mermaid)

本节描述了 AdWeb 广告管理平台的主要数据实体及其关系。详细的表结构定义请参见《数据库分析文档.md》和后续的关系模式表。

**图例说明:**
*   `PK`: 主键
*   `FK`: 外键
*   `UK`: 唯一约束
*   `||--o{` : 一对多关系 (0..N)
*   `||--|{` : 一对多关系 (1..N, "一"端强制参与, "多"端强制参与)
*   `}o--o{` : 多对多关系 (0..N on both sides)
*   `}o--|{` : 多对多关系 (0..N on "left", 1..N on "right")


```mermaid
erDiagram
    User {
        INT id PK
        VARCHAR username UK
        VARCHAR email UK
        VARCHAR password
        DECIMAL balance
        VARCHAR audit_status
        VARCHAR user_type
        VARCHAR phone
        VARCHAR company
        DATETIME date_joined
    }

    ValidationCode {
        INT id PK
        INT user_id FK
        VARCHAR code
        DATETIME expire_at
    }

    Notification {
        INT id PK
        INT user_id FK
        VARCHAR title
        TEXT content
        VARCHAR status
        DATETIME created_at
    }

    Campaign {
        INT id PK
        VARCHAR name
        INT advertiser_id FK
        DECIMAL budget
        DATETIME start_date
        DATETIME end_date
        VARCHAR status
    }

    AdPlacement {
        INT id PK
        VARCHAR placement_type UK
        VARCHAR dimension
        DECIMAL price_per_day
        BOOLEAN is_active
    }

    Ad {
        INT id PK
        VARCHAR name
        INT advertiser_id FK
        INT campaign_id FK
        INT placement_id FK
        DECIMAL budget
        DECIMAL daily_limit
        VARCHAR image_path
        VARCHAR target_url
        TEXT description
        VARCHAR status
        DATETIME start_date
        DATETIME end_date
    }

    AuditLog {
        INT id PK
        INT ad_id FK
        INT admin_id FK
        VARCHAR action
        TEXT reason
        DATETIME created_at
    }

    Transaction {
        INT id PK
        INT user_id FK
        DECIMAL amount
        VARCHAR transaction_type
        VARCHAR payment_method
        VARCHAR status
        INT ad_id FK
        TEXT description
        DATETIME created_at
    }

    InvoiceInfo {
        INT id PK
        INT user_id FK
        VARCHAR title
        VARCHAR tax_number
        VARCHAR address
        VARCHAR telephone
        VARCHAR bank_name
        VARCHAR bank_account
        BOOLEAN is_default
    }

    Invoice {
        INT id PK
        INT user_id FK
        INT invoice_info_id FK
        VARCHAR invoice_type
        DECIMAL amount
        VARCHAR title
        VARCHAR tax_number
        VARCHAR status
        VARCHAR email
        VARCHAR invoice_number
        DATE invoice_date
        DATETIME created_at
    }

    InvoiceItem {
        INT id PK
        INT invoice_id FK
        INT transaction_id FK
        DECIMAL amount
    }

    AdImpression {
        INT id PK
        INT ad_id FK
        DATETIME timestamp
        VARCHAR ip_address
        TEXT user_agent
        DECIMAL cost
    }

    AdClick {
        INT id PK
        INT ad_id FK
        INT impression_id FK
        DATETIME timestamp
        VARCHAR ip_address
        TEXT user_agent
        DECIMAL cost
    }

    DailyStats {
        INT id PK
        INT ad_id FK
        DATE date
        INT impressions
        INT clicks
        DECIMAL cost
    }

    User ||--o{ ValidationCode : "has"
    User ||--o{ Notification : "receives"
    User ||--o{ Campaign : "creates (as advertiser)"
    User ||--o{ Ad : "creates (as advertiser)"
    User ||--o{ AuditLog : "performs (as admin)"
    User ||--o{ Transaction : "initiates"
    User ||--o{ InvoiceInfo : "owns"
    User ||--o{ Invoice : "requests"

    Campaign ||--o{ Ad : "groups"
    AdPlacement ||--o{ Ad : "hosts"
    Ad ||--o{ AuditLog : "is audited"
    Ad ||--o{ Transaction : "relates to spend"
    Ad ||--o{ AdImpression : "generates"
    Ad ||--o{ AdClick : "generates"
    Ad ||--o{ DailyStats : "accumulates"

    AdImpression ||--o{ AdClick : "may lead to"

    InvoiceInfo ||--o{ Invoice : "provides details for"
    Invoice ||--o{ InvoiceItem : "is detailed by"
    Transaction ||--o{ InvoiceItem : "is itemized in"
```

**关系文字描述（已更新基数）:**
*   一个 `User` 可以有零或多个 `ValidationCode` 和 `Notification`。(1-0..N)
*   一个 `User` (作为广告主) 必须创建至少一个 `Campaign` 和 `Ad` 才能投放广告，但理论上可以只注册不创建。(1-0..N, 实际业务中可能是1..N)
*   一个 `User` (作为管理员) 可以执行零或多个 `AuditLog`。(1-0..N)
*   一个 `User` 可以发起零或多个 `Transaction`，必须拥有至少一个 `InvoiceInfo` (通常注册后或首次申请发票前创建默认的)，可以申请零或多个 `Invoice`。(1-0..N for Tx/Invoice, 1-1..N for InvoiceInfo)
*   一个 `Campaign` 必须包含至少一个 `Ad` 才能生效。(1-1..N)
*   一个 `AdPlacement` 可以承载零或多个 `Ad`。(1-0..N)
*   一个 `Ad` 可以有零或多个 `AuditLog`，在其生命周期内必须产生多个 `AdImpression` 和 `AdClick` (如果投放成功)，可以累积零或多个 `DailyStats`。(1-0..N for AuditLog/DailyStats, 1-1..N for Impression/Click if active)
*   一个 `AuditLog` 可以针对一个 `User` (如用户审核) 或一个 `Ad` (广告审核)。
*   一个 `AdImpression` 最多导致一个 `AdClick`。(1-0..1)
*   一个 `InvoiceInfo` 可以被用于零或多个 `Invoice` 申请。(1-0..N)
*   一个 `Invoice` 必须包含至少一个 `InvoiceItem`。(1-1..N)
*   一个 `Transaction` (通常是支出型) 可以被零或多个 `InvoiceItem` 包含 (例如，一个交易可能被拆分到不同发票，或不开发票)。(1-0..N)
*   `DailyStats` 可以是针对单个 `Ad`、`Campaign`、`User` (广告主) 或整个平台的统计。

### 3.2 关系模式表格

根据上述E-R图，将每个实体转化为关系模式，并用表格形式展示。

**User (用户表)**

| 字段名          | 数据类型         | 约束 (PK,FK,UK,NN) | 中文描述        | 备注 (Default, Extra)                      |
|-----------------|------------------|--------------------|-----------------|--------------------------------------------|
| id              | INT              | PK, NN             | 用户ID          | AUTO_INCREMENT                             |
| password        | VARCHAR(128)     | NN                 | 密码 (哈希)     | Django默认 (存储哈希值)                    |
| last_login      | DATETIME         | NULL               | 最后登录时间    |                                            |
| is_superuser    | BOOLEAN          | NN                 | 是否为超级用户  | DEFAULT False                              |
| username        | VARCHAR(150)     | UK, NN             | 用户名          |                                            |
| first_name      | VARCHAR(150)     | NULL               | 名字            |                                            |
| last_name       | VARCHAR(150)     | NULL               | 姓氏            |                                            |
| email           | VARCHAR(254)     | UK, NN             | 电子邮箱        |                                            |
| is_staff        | BOOLEAN          | NN                 | 是否为员工      | DEFAULT False (管理员为True)               |
| is_active       | BOOLEAN          | NN                 | 账户是否激活    | DEFAULT True                               |
| date_joined     | DATETIME         | NN                 | 注册时间        | DEFAULT CURRENT_TIMESTAMP                  |
| balance         | DECIMAL(10,2)    | NN                 | 账户余额        | DEFAULT 0.00                               |
| audit_status    | VARCHAR(20)      | NN                 | 审核状态        | pending, approved, rejected, DEFAULT 'pending' |
| user_type       | VARCHAR(20)      | NN                 | 用户类型        | advertiser, admin, DEFAULT 'advertiser'    |
| phone           | VARCHAR(20)      | NULL               | 电话号码        |                                            |
| company         | VARCHAR(100)     | NULL               | 公司名称        |                                            |

**ValidationCode (验证码表)**

| 字段名     | 数据类型     | 约束 (PK,FK,UK,NN) | 中文描述   | 备注 (Default, Extra)        |
|------------|--------------|--------------------|------------|------------------------------|
| id         | INT          | PK, NN             | 验证码ID   | AUTO_INCREMENT               |
| user_id    | INT          | FK (User.id), NN   | 用户ID     |                              |
| code       | VARCHAR(10)  | UK, NN             | 验证码     |                              |
| expire_at  | DATETIME     | NN                 | 过期时间   |                              |
| purpose    | VARCHAR(50)  | NN                 | 用途       | e.g., email_verification     |
| is_used    | BOOLEAN      | NN                 | 是否已使用 | DEFAULT False                |
| created_at | DATETIME     | NN                 | 创建时间   | DEFAULT CURRENT_TIMESTAMP    |

**Notification (通知表)**

| 字段名      | 数据类型     | 约束 (PK,FK,UK,NN) | 中文描述   | 备注 (Default, Extra)        |
|-------------|--------------|--------------------|------------|------------------------------|
| id          | INT          | PK, NN             | 通知ID     | AUTO_INCREMENT               |
| user_id     | INT          | FK (User.id), NN   | 接收用户ID |                              |
| title       | VARCHAR(255) | NN                 | 通知标题   |                              |
| content     | TEXT         | NN                 | 通知内容   |                              |
| status      | VARCHAR(20)  | NN                 | 状态       | unread, read, DEFAULT 'unread' |
| type        | VARCHAR(50)  | NULL               | 通知类型   | system, ad, invoice, etc.    |
| related_url | VARCHAR(255) | NULL               | 相关链接   |                              |
| created_at  | DATETIME     | NN                 | 创建时间   | DEFAULT CURRENT_TIMESTAMP    |

**Campaign (广告活动表)**

| 字段名        | 数据类型      | 约束 (PK,FK,UK,NN)          | 中文描述     | 备注 (Default, Extra)                                  |
|---------------|---------------|-----------------------------|--------------|--------------------------------------------------------|
| id            | INT           | PK, NN                      | 广告活动ID   | AUTO_INCREMENT                                         |
| name          | VARCHAR(100)  | NN                          | 活动名称     |                                                        |
| advertiser_id | INT           | FK (User.id), NN            | 广告主ID     |                                                        |
| budget        | DECIMAL(12,2) | NN                          | 总预算       |                                                        |
| daily_budget  | DECIMAL(10,2) | NULL                        | 每日预算     |                                                        |
| start_date    | DATETIME      | NN                          | 开始日期     |                                                        |
| end_date      | DATETIME      | NULL                        | 结束日期     | NULL表示不限                                           |
| status        | VARCHAR(20)   | NN                          | 状态         | active, paused, ended, deleted, pending_approval, DEFAULT 'pending_approval' |
| created_at    | DATETIME      | NN                          | 创建时间     | DEFAULT CURRENT_TIMESTAMP                              |
| updated_at    | DATETIME      | NN                          | 更新时间     | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP  |

**AdPlacement (广告位表)**

| 字段名         | 数据类型      | 约束 (PK,FK,UK,NN) | 中文描述    | 备注 (Default, Extra)        |
|----------------|---------------|--------------------|-------------|------------------------------|
| id             | INT           | PK, NN             | 广告位ID    | AUTO_INCREMENT               |
| name           | VARCHAR(100)  | UK, NN             | 广告位名称  |                              |
| placement_type | VARCHAR(50)   | NN                 | 广告位类型  | banner, sidebar, etc.        |
| dimension      | VARCHAR(50)   | NULL               | 尺寸        | e.g., "300x250"              |
| price_per_day  | DECIMAL(10,2) | NULL               | 每日价格    |                              |
| price_cpm      | DECIMAL(10,2) | NULL               | CPM价格     |                              |
| price_cpc      | DECIMAL(10,2) | NULL               | CPC价格     |                              |
| is_active      | BOOLEAN       | NN                 | 是否激活    | DEFAULT True                 |
| description    | TEXT          | NULL               | 描述        |                              |
| created_at     | DATETIME      | NN                 | 创建时间    | DEFAULT CURRENT_TIMESTAMP    |

**Ad (广告表)**

| 字段名          | 数据类型      | 约束 (PK,FK,UK,NN)                | 中文描述        | 备注 (Default, Extra)                                  |
|-----------------|---------------|-----------------------------------|-----------------|--------------------------------------------------------|
| id              | INT           | PK, NN                            | 广告ID          | AUTO_INCREMENT                                         |
| name            | VARCHAR(100)  | NN                                | 广告名称        |                                                        |
| advertiser_id   | INT           | FK (User.id), NN                  | 广告主ID        |                                                        |
| campaign_id     | INT           | FK (Campaign.id), NN              | 广告活动ID      |                                                        |
| placement_id    | INT           | FK (AdPlacement.id), NN           | 广告位ID        |                                                        |
| budget          | DECIMAL(10,2) | NULL                              | 广告预算        |                                                        |
| daily_limit     | DECIMAL(10,2) | NULL                              | 每日预算上限    |                                                        |
| creative_type   | VARCHAR(20)   | NN                                | 素材类型        | image, video, text, html                               |
| image_path      | VARCHAR(255)  | NULL                              | 图片素材路径    |                                                        |
| video_url       | VARCHAR(255)  | NULL                              | 视频素材URL     |                                                        |
| text_content    | TEXT          | NULL                              | 文本内容        |                                                        |
| html_content    | TEXT          | NULL                              | HTML内容        |                                                        |
| target_url      | VARCHAR(500)  | NN                                | 目标链接        |                                                        |
| description     | TEXT          | NULL                              | 广告描述        |                                                        |
| status          | VARCHAR(20)   | NN                                | 状态            | pending_approval, active, paused, ended, rejected, deleted, DEFAULT 'pending_approval' |
| start_date      | DATETIME      | NN                                | 投放开始日期    |                                                        |
| end_date        | DATETIME      | NULL                              | 投放结束日期    |                                                        |
| audit_remark    | TEXT          | NULL                              | 审核备注        |                                                        |
| created_at      | DATETIME      | NN                                | 创建时间        | DEFAULT CURRENT_TIMESTAMP                              |
| updated_at      | DATETIME      | NN                                | 更新时间        | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP  |

**AuditLog (审核日志表)**

| 字段名          | 数据类型    | 约束 (PK,FK,UK,NN)                       | 中文描述     | 备注 (Default, Extra)     |
|-----------------|-------------|------------------------------------------|--------------|---------------------------|
| id              | INT         | PK, NN                                   | 审核日志ID   | AUTO_INCREMENT            |
| ad_id           | INT         | FK (Ad.id), NULL                         | 广告ID       |                             |
| user_audit_id   | INT         | FK (User.id), NULL                       | 被审核用户ID |                             |
| admin_id        | INT         | FK (User.id), NN                         | 管理员ID     |                             |
| entity_type     | VARCHAR(50) | NN                                       | 审核实体类型 | ad, user                    |
| action          | VARCHAR(50) | NN                                       | 操作         | approve, reject, comment    |
| reason          | TEXT        | NULL                                     | 原因/备注    |                             |
| previous_status | VARCHAR(20) | NULL                                     | 先前状态     |                             |
| new_status      | VARCHAR(20) | NN                                       | 新状态       |                             |
| created_at      | DATETIME    | NN                                       | 创建时间     | DEFAULT CURRENT_TIMESTAMP |

**Transaction (交易记录表)**

| 字段名         | 数据类型      | 约束 (PK,FK,UK,NN)            | 中文描述     | 备注 (Default, Extra)        |
|----------------|---------------|-------------------------------|--------------|------------------------------|
| id             | INT           | PK, NN                        | 交易ID       | AUTO_INCREMENT               |
| user_id        | INT           | FK (User.id), NN              | 用户ID       |                              |
| amount         | DECIMAL(10,2) | NN                            | 金额         | 正为收入,负为支出            |
| transaction_type | VARCHAR(20) | NN                            | 交易类型     | recharge, ad_spend, refund, withdrawal |
| payment_method | VARCHAR(50)   | NULL                          | 支付方式     |                              |
| status         | VARCHAR(20)   | NN                            | 状态         | pending, completed, failed, cancelled |
| ad_id          | INT           | FK (Ad.id), NULL              | 关联广告ID   |                              |
| invoice_id     | INT           | FK (Invoice.id), NULL         | 关联发票ID   |                              |
| description    | TEXT          | NULL                          | 描述/备注    |                              |
| external_id    | VARCHAR(100)  | UK, NULL                      | 外部交易号   |                              |
| created_at     | DATETIME      | NN                            | 创建时间     | DEFAULT CURRENT_TIMESTAMP    |
| completed_at   | DATETIME      | NULL                          | 完成时间     |                              |

**InvoiceInfo (发票抬头信息表)**

| 字段名        | 数据类型     | 约束 (PK,FK,UK,NN) | 中文描述     | 备注 (Default, Extra)     |
|---------------|--------------|--------------------|--------------|---------------------------|
| id            | INT          | PK, NN             | 发票抬头ID   | AUTO_INCREMENT            |
| user_id       | INT          | FK (User.id), NN   | 用户ID       |                           |
| title         | VARCHAR(255) | UK, NN             | 发票抬头     |                           |
| tax_number    | VARCHAR(50)  | UK, NN             | 税号         |                           |
| address       | VARCHAR(255) | NULL               | 公司地址     |                           |
| telephone     | VARCHAR(50)  | NULL               | 公司电话     |                           |
| bank_name     | VARCHAR(100) | NULL               | 开户行名称   |                           |
| bank_account  | VARCHAR(50)  | NULL               | 银行账号     |                           |
| is_default    | BOOLEAN      | NN                 | 是否默认     | DEFAULT False             |
| created_at    | DATETIME     | NN                 | 创建时间     | DEFAULT CURRENT_TIMESTAMP |

**Invoice (发票表)**

| 字段名          | 数据类型      | 约束 (PK,FK,UK,NN)                 | 中文描述      | 备注 (Default, Extra)     |
|-----------------|---------------|------------------------------------|---------------|---------------------------|
| id              | INT           | PK, NN                             | 发票ID        | AUTO_INCREMENT            |
| user_id         | INT           | FK (User.id), NN                   | 用户ID        |                           |
| invoice_info_id | INT           | FK (InvoiceInfo.id), NN            | 发票抬头ID    |                           |
| invoice_number  | VARCHAR(50)   | UK, NULL                           | 发票号码      |                           |
| invoice_type    | VARCHAR(20)   | NN                                 | 发票类型      | normal, special, electronic |
| amount          | DECIMAL(10,2) | NN                                 | 发票金额      |                           |
| content         | VARCHAR(255)  | NN                                 | 发票内容      | e.g., "广告服务费"          |
| status          | VARCHAR(20)   | NN                                 | 状态          | pending, processing, completed, rejected, cancelled, sent, DEFAULT 'pending' |
| email           | VARCHAR(254)  | NULL                               | 接收邮箱      |                           |
| admin_remark    | TEXT          | NULL                               | 管理员备注    |                           |
| pdf_url         | VARCHAR(255)  | NULL                               | PDF链接       |                           |
| created_at      | DATETIME      | NN                                 | 申请时间      | DEFAULT CURRENT_TIMESTAMP |
| updated_at      | DATETIME      | NN                                 | 更新时间      | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |
| invoice_date    | DATE          | NULL                               | 开票日期      |                           |

**InvoiceItem (发票项目表)**

| 字段名        | 数据类型      | 约束 (PK,FK,UK,NN)                                  | 中文描述    | 备注 (Default, Extra)     |
|---------------|---------------|-----------------------------------------------------|-------------|---------------------------|
| id            | INT           | PK, NN                                              | 发票项目ID  | AUTO_INCREMENT            |
| invoice_id    | INT           | FK (Invoice.id), NN                                 | 发票ID      |                           |
| transaction_id| INT           | FK (Transaction.id), NN, UK (`invoice_id`, `transaction_id`) | 关联交易ID  |                           |
| amount        | DECIMAL(10,2) | NN                                                  | 项目金额    |                           |
| description   | TEXT          | NULL                                                | 项目描述    |                           |

**AdImpression (广告展示记录表)**

| 字段名        | 数据类型     | 约束 (PK,FK,UK,NN) | 中文描述     | 备注 (Default, Extra)     |
|---------------|--------------|--------------------|--------------|---------------------------|
| id            | BIGINT       | PK, NN             | 广告展示ID   | AUTO_INCREMENT            |
| ad_id         | INT          | FK (Ad.id), NN     | 广告ID       |                           |
| timestamp     | DATETIME(6)  | NN                 | 展示时间     | DEFAULT CURRENT_TIMESTAMP(6)|
| ip_address    | VARCHAR(45)  | NULL               | IP地址       |                           |
| user_agent    | TEXT         | NULL               | 用户代理     |                           |
| cost          | DECIMAL(8,4) | NULL               | 本次展示花费 | (CPM计费)                 |
| device_type   | VARCHAR(50)  | NULL               | 设备类型     |                           |
| geo_location  | VARCHAR(100) | NULL               | 地理位置     |                           |

**AdClick (广告点击记录表)**

| 字段名        | 数据类型     | 约束 (PK,FK,UK,NN)                   | 中文描述    | 备注 (Default, Extra)     |
|---------------|--------------|--------------------------------------|-------------|---------------------------|
| id            | BIGINT       | PK, NN                               | 广告点击ID  | AUTO_INCREMENT            |
| ad_id         | INT          | FK (Ad.id), NN                       | 广告ID      |                           |
| impression_id | BIGINT       | FK (AdImpression.id), NULL, UK (`ad_id`, `impression_id`) | 关联展示ID  |                           |
| timestamp     | DATETIME(6)  | NN                                   | 点击时间    | DEFAULT CURRENT_TIMESTAMP(6)|
| ip_address    | VARCHAR(45)  | NULL                                 | IP地址      |                           |
| user_agent    | TEXT         | NULL                                 | 用户代理    |                           |
| cost          | DECIMAL(8,4) | NULL                                 | 本次点击花费| (CPC计费)                 |
| referer_url   | VARCHAR(500) | NULL                                 | 来源URL     |                           |

**DailyStats (每日统计表)**

| 字段名        | 数据类型      | 约束 (PK,FK,UK,NN)                                             | 中文描述      | 备注 (Default, Extra)     |
|---------------|---------------|----------------------------------------------------------------|---------------|---------------------------|
| id            | INT           | PK, NN                                                         | 每日统计ID    | AUTO_INCREMENT            |
| date          | DATE          | NN                                                             | 统计日期      |                           |
| stat_level    | VARCHAR(20)   | NN                                                             | 统计层级      | ad, campaign, advertiser, platform |
| ad_id         | INT           | FK (Ad.id), NULL                                               | 广告ID        |                           |
| campaign_id   | INT           | FK (Campaign.id), NULL                                         | 广告活动ID    |                           |
| advertiser_id | INT           | FK (User.id), NULL                                             | 广告主ID      |                           |
| impressions   | INT           | NN, DEFAULT 0                                                  | 总展示数      |                           |
| clicks        | INT           | NN, DEFAULT 0                                                  | 总点击数      |                           |
| cost          | DECIMAL(12,2) | NN, DEFAULT 0.00                                               | 总花费        |                           |
| ctr           | DECIMAL(5,4)  | NULL                                                           | 点击率        | (计算值)                  |
| cpc           | DECIMAL(10,2) | NULL                                                           | 平均点击成本  | (计算值)                  |
| cpm           | DECIMAL(10,2) | NULL                                                           | 平均千次展示成本| (计算值)                  |
|               |               | UK (`date`, `stat_level`, `ad_id`, `campaign_id`, `advertiser_id`) |               | 保证每日各层级唯一性      |

## 4. 数据流图 (DFD)

数据流图 (DFD) 描述了系统中的数据流动和处理过程。

### 4.1 0层DFD (上下文图)

```plantuml
@startuml ContextDFD
title AdWeb 广告管理平台 - 0层DFD (上下文图)
left to right direction

actor "广告主" as Advertiser
actor "管理员" as Admin
database "支付服务" as PaymentGateway
cloud "广告网络/媒体" as AdNetwork

rectangle "AdWeb广告管理平台" as AdWebSystem #APPLICATION

Advertiser --> AdWebSystem : 用户注册信息, 登录凭证, 账户操作请求, 广告活动/广告创建请求, 充值请求, 发票申请
AdWebSystem --> Advertiser : 账户信息, 审核状态, 广告数据, 财务报表, 发票, 系统通知

Admin --> AdWebSystem : 登录凭证, 用户/广告审核操作, 广告位管理请求, 系统配置请求, 财务审批操作
AdWebSystem --> Admin : 用户/广告列表, 系统报表, 待处理任务, 系统通知

AdWebSystem --> PaymentGateway : 支付请求 (充值)
PaymentGateway --> AdWebSystem : 支付结果

AdWebSystem --> AdNetwork : 广告投放指令, 广告素材
AdNetwork --> AdWebSystem : 广告展示/点击原始数据
AdWebSystem --> AdNetwork : (可能的结算指令)
@enduml
```
**0层DFD说明:**
*   **外部实体**:
    *   广告主 (Advertiser):系统的主要用户，进行广告投放和财务管理。
    *   管理员 (Admin): 系统的维护和管理者，进行审核和配置。
    *   支付服务 (PaymentGateway): 处理充值支付的外部服务。
    *   广告网络/媒体 (AdNetwork): 实际展示广告的外部平台或媒体。
*   **核心系统**: AdWeb广告管理平台，作为一个整体处理所有数据和交互。
*   **主要数据流**: 概括了各外部实体与核心系统之间最重要的数据输入和输出。

### 4.2 1层DFD

```plantuml
@startuml Level1DFD
' 显式声明为组件图（避免自动推断为类图）
' 兼容 PlantUML 1.2025.2 版本语法
title AdWeb 广告管理平台 - 1层DFD
left to right direction

' 外部实体（组件图中用 [实体名] 表示）
[广告主] as Advertiser
[管理员] as Admin
[支付服务] as PaymentGateway

' 外部网络环境（用 cloud 表示）
cloud "广告网络/媒体" as AdNetwork

' 系统边界（组件图的 package 表示系统内部）
package "AdWeb广告管理平台" {
  ' 处理过程（组件图中用 [处理名称] 表示）
  [1.0 用户管理] as P1_UserMgmt
  [2.0 广告管理] as P2_AdMgmt
  [3.0 财务管理] as P3_FinanceMgmt
  [4.0 数据与报表] as P4_DataReport
  [5.0 系统配置与审计] as P5_SysConfigAudit

  ' 数据存储（组件图中用 [<<database>> 存储名] 表示）
  [<<database>> 用户数据存储] as DS_Users
  [<<database>> 广告数据存储] as DS_Ads
  [<<database>> 财务数据存储] as DS_Finance
  [<<database>> 统计数据存储] as DS_Stats
  [<<database>> 配置与日志数据存储] as DS_ConfigLog
}

' 数据流（组件图中用 -- 表示双向，-> 表示单向）
Advertiser -- P1_UserMgmt : 用户注册信息, 登录凭证, 个人资料更新
P1_UserMgmt -- Advertiser : 账户信息, 验证结果, 通知

Admin -- P1_UserMgmt : 用户审核指令, 用户管理指令
P1_UserMgmt -- Admin : 用户列表, 审核结果

P1_UserMgmt <-> DS_Users : 用户基础数据读写
P1_UserMgmt -> DS_ConfigLog : 用户操作日志写入

Advertiser -- P2_AdMgmt : 广告创建请求, 素材文件, 状态变更申请
P2_AdMgmt -- Advertiser : 广告列表, 广告状态, 审核结果, 预览链接

Admin -- P2_AdMgmt : 广告审核指令, 广告位配置, 投放参数设置
P2_AdMgmt -- Admin : 待审核广告列表, 全量广告清单

P2_AdMgmt <-> DS_Ads : 广告活动数据读写
P2_AdMgmt -> DS_ConfigLog : 广告操作日志写入
P2_AdMgmt --> AdNetwork : 广告投放指令（含素材与参数）

Advertiser -- P3_FinanceMgmt : 充值申请, 发票开具请求, 发票信息修改
P3_FinanceMgmt -- Advertiser : 交易记录, 账户余额, 发票状态, 电子发票

Admin -- P3_FinanceMgmt : 充值审核指令, 发票审批指令, 财务参数配置
P3_FinanceMgmt -- Admin : 待处理财务任务, 财务统计报表

P3_FinanceMgmt <-> DS_Finance : 交易记录/发票数据读写
P3_FinanceMgmt <-> DS_Users : 用户余额更新
P3_FinanceMgmt <-> PaymentGateway : 支付请求/结果交互
P3_FinanceMgmt -> DS_ConfigLog : 财务操作日志写入

AdNetwork -- P4_DataReport : 广告展示/点击原始数据
P2_AdMgmt -- P4_DataReport : 广告花费数据, 广告基础信息
P3_FinanceMgmt -- P4_DataReport : 交易对账数据

P4_DataReport <-> DS_Stats : 处理后统计数据读写
P4_DataReport <-> DS_Ads : 广告元数据读取关联
P4_DataReport -- Advertiser : 广告效果报表
P4_DataReport -- Admin : 系统运营报表, 广告主消费报表
P4_DataReport -> DS_ConfigLog : 数据处理日志写入

Admin -- P5_SysConfigAudit : 系统参数配置指令, 权限管理指令
P5_SysConfigAudit -- Admin : 配置生效反馈, 审计日志查询结果

P5_SysConfigAudit <-> DS_ConfigLog : 系统配置/审计日志读写
P1_UserMgmt <-> P5_SysConfigAudit : 用户权限配置交互
P2_AdMgmt <-> P5_SysConfigAudit : 广告投放参数交互
P3_FinanceMgmt <-> P5_SysConfigAudit : 财务规则参数交互

note right of P1_UserMgmt : 功能：用户注册、登录、认证、\n授权、资料管理、用户审核
note right of P2_AdMgmt : 功能：广告活动/广告创建、\n素材管理、审核、投放指令下发
note right of P3_FinanceMgmt : 功能：账户充值、支付对接、\n交易记录管理、发票处理
note right of P4_DataReport : 功能：广告数据收集、清洗、\n聚合、报表生成
note right of P5_SysConfigAudit : 功能：系统参数配置、\n用户权限管理、审计日志查询
@enduml
```
**1层DFD说明:**
*   **主要数据处理过程**:
    *   `1.0 用户管理`: 负责用户账户、认证、资料管理和审核。
    *   `2.0 广告管理`: 负责广告活动、广告、广告位、素材的管理和审核。
    *   `3.0 财务管理`: 负责充值、交易、发票管理和审批。
    *   `4.0 数据与报表`: 负责收集广告效果数据，生成统计报表。
    *   `5.0 系统配置与审计`: 负责系统参数配置、权限管理和操作审计。
*   **数据存储**:
    *   `用户数据存储 (DS_Users)`: 存储User, ValidationCode等。
    *   `广告数据存储 (DS_Ads)`: 存储Campaign, Ad, AdPlacement, AdImpression, AdClick等。
    *   `财务数据存储 (DS_Finance)`: 存储Transaction, Invoice, InvoiceItem, InvoiceInfo等。
    *   `统计数据存储 (DS_Stats)`: 存储DailyStats等汇总数据。
    *   `配置与日志数据存储 (DS_ConfigLog)`: 存储系统配置信息、AuditLog, Notification等。
*   **主要数据流**: 展示了数据在不同处理过程、外部实体和数据存储之间的流动路径。

## 5. 类图 (Class Diagram)

类图从面向对象的角度描述系统中的主要类及其属性、方法和关系。这些类主要源自 Django 模型。

```plantuml
@startuml FullClassDiagramEnhanced
title AdWeb 平台核心类图
skinparam monochrome true
hide empty members

abstract class BaseModel {
  +id: int (PK)
  +created_at: DateTime
  +updated_at: DateTime
}

class User extends BaseModel {
  +username: string (UK)
  +email: string (UK)
  -password_hash: string
  +balance: Decimal
  +audit_status: AuditStatusEnum
  +user_type: UserTypeEnum
  +phone: string
  +company: string
  +is_active: boolean
  +is_staff: boolean
  +is_superuser: boolean
  +last_login: DateTime
  -- Methods --
  +set_password(raw_password)
  +check_password(raw_password): boolean
  +has_perm(permission_codemane): boolean
  +get_advertiser_profile(): AdvertiserProfile
  +get_admin_profile(): AdminProfile
}
enum UserTypeEnum {
  ADVERTISER
  ADMIN
}
enum AuditStatusEnum {
  PENDING
  APPROVED
  REJECTED
}

class ValidationCode extends BaseModel {
  +user: User (FK)
  +code: string (UK)
  +expire_at: DateTime
  +purpose: string
  +is_used: boolean
  -- Methods --
  +is_expired(): boolean
}

class Notification extends BaseModel {
  +recipient: User (FK)
  +sender: User (FK, nullable)
  +title: string
  +content: string
  +status: NotificationStatusEnum
  +type: NotificationTypeEnum
  +related_url: string
}
enum NotificationStatusEnum {
 UNREAD
 READ
}
enum NotificationTypeEnum {
  SYSTEM_GENERAL
  USER_AUDIT
  AD_AUDIT
  INVOICE_STATUS
  TRANSACTION_UPDATE
  CAMPAIGN_ALERT
}


class Campaign extends BaseModel {
  +name: string
  +advertiser: User (FK)
  +budget: Decimal
  +daily_budget: Decimal (nullable)
  +start_date: DateTime
  +end_date: DateTime (nullable)
  +status: CampaignStatusEnum
  -- Methods --
  +calculate_spent_budget(): Decimal
  +get_active_ads(): QuerySet<Ad>
  +pause()
  +resume()
  +end_campaign()
}
enum CampaignStatusEnum {
  PENDING_APPROVAL
  ACTIVE
  PAUSED
  ENDED
  DELETED
  DRAFT
}

class AdPlacement extends BaseModel {
  +name: string (UK)
  +placement_type: AdPlacementTypeEnum
  +dimension: string
  +price_per_day: Decimal (nullable)
  +price_cpm: Decimal (nullable)
  +price_cpc: Decimal (nullable)
  +is_active: boolean
  +description: string
}
enum AdPlacementTypeEnum {
  BANNER
  SIDEBAR
  POPUP
  TEXT_LINK
  VIDEO_OVERLAY
  NATIVE
}

class Ad extends BaseModel {
  +name: string
  +advertiser: User (FK)
  +campaign: Campaign (FK)
  +placement: AdPlacement (FK)
  +budget: Decimal (nullable)
  +daily_limit: Decimal (nullable)
  +creative_type: CreativeTypeEnum
  +image_path: string (nullable)
  +video_url: string (nullable)
  +text_content: string (nullable)
  +html_content: string (nullable)
  +target_url: string
  +status: AdStatusEnum
  +start_date: DateTime
  +end_date: DateTime (nullable)
  +audit_remark: string (nullable)
  -- Methods --
  +get_total_impressions(): int
  +get_total_clicks(): int
  +get_ctr(): float
  +get_total_cost(): Decimal
  +submit_for_approval()
  +approve_ad(admin: User, remark: string)
  +reject_ad(admin: User, remark: string)
}
enum CreativeTypeEnum {
  IMAGE
  VIDEO
  TEXT
  HTML
}
enum AdStatusEnum {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  PAUSED
  ENDED
  REJECTED
  DELETED
}

class AuditLog extends BaseModel {
  +entity_type: string  // "Ad", "User", "Campaign"
  +entity_id: int
  +admin: User (FK)
  +action: string // "approve", "reject", "comment", "update_status"
  +reason: string (nullable)
  +previous_status: string (nullable)
  +new_status: string
  +details: JSONField (nullable) // Store additional context
}

class Transaction extends BaseModel {
  +user: User (FK)
  +amount: Decimal // Positive for income/recharge, negative for expense
  +transaction_type: TransactionTypeEnum
  +payment_method: PaymentMethodEnum (nullable)
  +status: TransactionStatusEnum
  +ad: Ad (FK, nullable)
  +invoice: Invoice (FK, nullable)
  +description: string (nullable)
  +external_id: string (UK, nullable)
  +completed_at: DateTime (nullable)
}
enum TransactionTypeEnum {
  RECHARGE
  AD_SPEND
  REFUND
  WITHDRAWAL
  SYSTEM_ADJUSTMENT
}
enum PaymentMethodEnum {
  BALANCE
  ALIPAY
  WECHAT_PAY
  BANK_TRANSFER
  CREDIT_CARD
}
enum TransactionStatusEnum {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

class InvoiceInfo extends BaseModel {
  +user: User (FK)
  +title: string (UK with user)
  +tax_number: string (UK with user)
  +address: string (nullable)
  +telephone: string (nullable)
  +bank_name: string (nullable)
  +bank_account: string (nullable)
  +is_default: boolean
}

class Invoice extends BaseModel {
  +user: User (FK)
  +invoice_info: InvoiceInfo (FK)
  +invoice_number: string (UK, nullable)
  +invoice_type: InvoiceTypeEnum
  +amount: Decimal
  +content_description: string // e.g., "广告服务费"
  +status: InvoiceStatusEnum
  +recipient_email: string (nullable) // For electronic invoice
  +admin_remark: string (nullable)
  +pdf_url: string (nullable)
  +invoice_date: Date (nullable)
  -- Methods --
  +add_item(transaction: Transaction, amount: Decimal)
  +mark_as_processing(admin: User)
  +mark_as_completed(admin: User, invoice_num: string, date: Date)
  +mark_as_rejected(admin: User, remark: string)
}
enum InvoiceTypeEnum {
  NORMAL
  SPECIAL
  ELECTRONIC
}
enum InvoiceStatusEnum {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
  SENT
}

class InvoiceItem extends BaseModel {
  +invoice: Invoice (FK)
  +transaction: Transaction (FK)
  +amount: Decimal
  +description: string (nullable)
}

class AdImpression extends BaseModel {
  +ad: Ad (FK)
  +timestamp: DateTime(6)
  +ip_address: string (nullable)
  +user_agent: string (nullable)
  +cost: Decimal (nullable) // Cost for this impression (CPM)
  +device_type: string (nullable)
  +geo_location: string (nullable)
}

class AdClick extends BaseModel {
  +ad: Ad (FK)
  +impression: AdImpression (FK, nullable, UK with ad)
  +timestamp: DateTime(6)
  +ip_address: string (nullable)
  +user_agent: string (nullable)
  +cost: Decimal (nullable) // Cost for this click (CPC)
  +referer_url: string (nullable)
}

class DailyStats extends BaseModel {
  +date: Date
  +stat_level: string // "ad", "campaign", "advertiser", "platform"
  +entity_id: int (FK to Ad/Campaign/User based on stat_level, nullable)
  +impressions: int
  +clicks: int
  +cost: Decimal
  +ctr: float (calculated)
  +cpc: Decimal (calculated)
  +cpm: Decimal (calculated)
  -- Static Methods --
  +aggregate_for_ad(ad: Ad, date: Date)
  +aggregate_for_campaign(campaign: Campaign, date: Date)
}

User "1" -- "0..*" ValidationCode : owns >
User "1" -- "0..*" Notification : receives >
User "1" -- "0..*" Campaign : advertiser creates >
User "1" -- "0..*" Ad : advertiser creates >
User "1" -- "0..*" AuditLog : admin performs >
User "1" -- "0..*" Transaction : initiates >
User "1" -- "1..*" InvoiceInfo : owns >
User "1" -- "0..*" Invoice : requests >

Campaign "1" -- "1..*" Ad : contains >
AdPlacement "1" -- "0..*" Ad : hosts >
Ad "1" -- "0..*" AuditLog : is_audited_by <
Ad "0..1" -- "0..*" Transaction : relates_to_spend <
Ad "1" -- "0..*" AdImpression : generates >
Ad "1" -- "0..*" AdClick : generates >
Ad "0..1" -- "0..*" DailyStats : accumulates_for <

AuditLog "1" -- "1" User : performed_by (admin) <
' An AuditLog refers to one Ad OR one User
AuditLog "1" -- "0..1" Ad : audits_ad (FK: entity_id where entity_type='Ad')
AuditLog "1" -- "0..1" User : audits_user (FK: entity_id where entity_type='User')


AdImpression "0..1" -- "1" AdClick : leads_to >

InvoiceInfo "1" -- "0..*" Invoice : provides_details_for >
Invoice "1" -- "1..*" InvoiceItem : contains >
Transaction "1" -- "0..*" InvoiceItem : is_itemized_in <

DailyStats "0..1" -- "0..1" Ad : stats_for_ad (FK: entity_id where stat_level='ad')
DailyStats "0..1" -- "0..1" Campaign : stats_for_campaign (FK: entity_id where stat_level='campaign')
DailyStats "0..1" -- "0..1" User : stats_for_advertiser (FK: entity_id where stat_level='advertiser')

BaseModel <|-- User
BaseModel <|-- ValidationCode
BaseModel <|-- Notification
BaseModel <|-- Campaign
BaseModel <|-- AdPlacement
BaseModel <|-- Ad
BaseModel <|-- AuditLog
BaseModel <|-- Transaction
BaseModel <|-- InvoiceInfo
BaseModel <|-- Invoice
BaseModel <|-- InvoiceItem
BaseModel <|-- AdImpression
BaseModel <|-- AdClick
BaseModel <|-- DailyStats
@enduml
```

## 6. 状态图 (State Diagram)

状态图描述了对象在其生命周期内的各种状态以及状态之间的转换。

### 6.1 用户审核状态 (User `audit_status`)

```plantuml
@startuml UserAuditStatus
title User Audit Status (User.audit_status)

state "待审核 (pending)" as Pending
state "已批准 (approved)" as Approved
state "已拒绝 (rejected)" as Rejected
state "需补充资料 (more_info_required)" as MoreInfo

[*] --> Pending : 用户注册提交
Pending --> Approved : 管理员批准
Pending --> Rejected : 管理员拒绝
Pending --> MoreInfo : 管理员要求补充资料
MoreInfo --> Pending : 用户补充资料后重新提交
Rejected --> Pending : (允许)用户修改信息后重新申请
Approved --> Rejected : (罕见)因违规等被撤销批准
Approved --> Pending : (罕见)因违规等被冻结重审

' 替换为旧版本兼容的注释语法（note 直接跟在转移线后）
Pending --> Approved : 管理员批准
note right: 触发: Admin sets audit_status = 'approved'\n动作: 发送批准通知给用户

Pending --> Rejected : 管理员拒绝
note right: 触发: Admin sets audit_status = 'rejected'\n动作: 发送拒绝通知给用户 (附原因)
@enduml
```

### 6.2 发票申请状态 (Invoice `status`)

```plantuml
@startuml InvoiceStatus
title Invoice Application Status (Invoice.status)
skinparam stateStyle roundedrectangle  ' 圆角矩形状态框
skinparam backgroundColor #f9f9f9      ' 背景色
skinparam stateBorderColor #666666      ' 状态边框颜色
skinparam arrowhead size 8,8            ' 箭头大小

' 状态定义（分层排列：初始状态→处理中→最终状态）
state "待处理 (pending)" as Pending
state "处理中 (processing)" as Processing
state "已开具/完成 (completed)" as Completed
state "已拒绝 (rejected)" as Rejected
state "已取消 (cancelled)" as Cancelled
state "已发送 (sent)" as Sent #LightBlue

' 状态转移（优化路径避免交叉）
[*] --> Pending : 用户提交发票申请

Pending --> Processing : 管理员审核通过
Pending --> Rejected : 管理员审核拒绝
Pending --> Cancelled : 用户处理前取消

Processing --> Completed : 管理员完成开票
Processing --> Rejected : 处理中发现问题
Processing --> Cancelled : 特殊情况取消

Completed --> Sent : 系统发送发票
Sent --> Completed : 视为同一状态阶段

' 注释（优化位置，使用独立块避免遮挡）
note left of Pending: 初始状态\n所有申请的起点
note right of Processing: 中间处理状态\n包含审核和开票操作
note right of Completed: 完成状态\n后续可发送发票

note bottom of Rejected: 终止状态\n申请被拒绝（附原因）
note bottom of Cancelled: 终止状态\n申请被取消（主动/被动）
note top of Sent: 最终状态\n发票已投递（电子/纸质）

' 兼容旧版本的转移线注释
Processing --> Completed : 管理员完成开票操作
note right of Processing: 触发: Admin设置completed\n动作: 通知用户

Completed --> Sent : 系统发送电子发票
note right of Completed: 触发: 系统发送或标记邮寄\n动作: 更新投递信息
@enduml
```

### 6.3 广告活动状态 (Campaign `status`)

```plantuml
@startuml CampaignStatus
title Campaign Status (Campaign.status)

' 状态定义（无任何注释跟随）
state "草稿 (draft)" as Draft
state "待审核 (pending_approval)" as PendingApproval
state "进行中 (active)" as Active
state "已暂停 (paused)" as Paused
state "已结束 (ended)" as Ended
state "已删除 (deleted)" as Deleted #LightCoral
state "已拒绝 (rejected)" as Rejected

' 状态转移（触发条件明确）
[*] --> Draft : 用户创建活动但未提交
Draft --> PendingApproval : 用户提交审核
PendingApproval --> Active : 管理员审核通过
PendingApproval --> Draft : 管理员打回修改
PendingApproval --> Rejected : 管理员审核拒绝

Active --> Paused : 用户/管理员暂停
Paused --> Active : 用户/管理员恢复
Active --> Ended : 到达结束日期/预算耗尽/手动结束
Paused --> Ended : 到达结束日期/手动结束

Active --> Deleted : 用户/管理员删除
Paused --> Deleted : 用户/管理员删除
Ended --> Deleted : 用户/管理员删除
PendingApproval --> Deleted : 用户/管理员删除
Draft --> Deleted : 用户/管理员删除

' 独立注释（旧版本唯一兼容方式）
note right of Ended
  系统也可能根据
  end_date 自动更新
  状态为 ended。
  预算耗尽也会导致 ended。
end note

note right of Active
  Active --> Paused
  影响: 该活动下所有 active 的广告将暂停投放
end note
@enduml
```

### 6.4 广告状态 (Ad `status`)

```plantuml
@startuml AdStatus
title Ad Status (Ad.status)

' 状态定义（无任何注释跟随）
state "草稿 (draft)" as Draft
state "待审核 (pending_approval)" as PendingApproval
state "投放中 (active)" as Active
state "已暂停 (paused)" as Paused
state "已结束 (ended)" as Ended
state "已拒绝 (rejected)" as Rejected
state "已删除 (deleted)" as Deleted #LightCoral

' 状态转移（触发条件明确）
[*] --> Draft : 用户创建广告但未提交
Draft --> PendingApproval : 用户提交审核

PendingApproval --> Active : 管理员审核通过
PendingApproval --> Rejected : 管理员审核拒绝
PendingApproval --> Draft : 管理员打回修改

Active --> Paused : 用户手动暂停/所属Campaign暂停/预算耗尽
Paused --> Active : 用户手动恢复/所属Campaign恢复/预算补充

Active --> Ended : 到达结束日期/总预算耗尽/所属Campaign结束
Paused --> Ended : 到达结束日期/手动结束

Rejected --> Draft : 修改后重新提交
Rejected --> Deleted : 用户删除

Active --> Deleted : 用户/管理员删除
Paused --> Deleted : 用户/管理员删除
Ended --> Deleted : 用户/管理员删除
Draft --> Deleted : 用户/管理员删除

' 独立注释（旧版本唯一兼容方式）
note right of Active
  Active --> Paused
  原因:
  1. 用户操作暂停此广告
  2. 所属 Campaign 状态变为 paused
  3. 广告日预算耗尽 (次日可能自动恢复)
  4. 广告总预算耗尽 (需充值或调整预算)
end note

note right of PendingApproval
  PendingApproval --> Active
  动作:
  - 创建 AuditLog
  - 通知广告主
end note

note right of PendingApproval
  PendingApproval --> Rejected
  动作:
  - 创建 AuditLog (含原因)
  - 通知广告主
end note
@enduml
```

## 7. 活动图 (Activity Diagram) - 带泳道

活动图描述了业务流程中的活动序列和控制流程，使用泳道区分不同参与者的活动。

### 7.1 用户注册与审核流程 (带泳道)

```plantuml
@startuml UserRegistrationActivitySwimlanes
title User Registration and Audit Process (Swimlanes)

|潜在用户|
start
:访问注册页面;
:填写注册信息 (邮箱, 用户名, 密码等);
:同意服务条款;
:提交注册表单;

|系统校验|
:验证表单数据格式与完整性;
if (邮箱是否已注册?) then (是)
  |潜在用户|
  :接收"邮箱已存在"提示;
  stop
else (否)
  if (用户名是否已存在?) then (是)
    |潜在用户|
    :接收"用户名已存在"提示;
    stop
  else (否)
    if (密码强度是否符合要求?) then (不符合)
      |潜在用户|
      :接收"密码太弱"提示;
      stop
    else (符合)
      |系统核心处理|
      :创建用户账户 (status: pending);
      :生成邮箱验证码 (ValidationCode);
      :发送验证邮件 (含验证链接/验证码);
      :记录用户注册尝试日志;
      |潜在用户|
      :接收"注册成功，请查收邮件完成验证"提示;
      :查收邮件并点击验证链接 / 输入验证码;
      |系统核心处理|
      if (邮箱验证成功?) then (是)
        :更新用户状态 (status: pending_approval / is_verified: true);
        :通知管理员新用户待审核;
        |潜在用户|
        :接收"邮箱验证成功，等待管理员审核"提示;
      else (否 - 验证码错误/过期)
        |潜在用户|
        :接收"验证失败"提示;
        stop
      endif
    endif
  endif
endif

|管理员|
partition "用户审核" {
  :登录系统;
  :访问"用户审核"模块;
  :查看待审核用户列表 (含注册信息);
  :选择用户进行审核;
  if (信息是否完整且合规?) then (是)
    :选择"批准";
  else (否 - 如公司信息可疑)
    if (是否需要补充资料?) then (是)
      :选择"要求补充资料";
      :填写需补充内容;
      |系统核心处理|
      :更新用户状态 (status: more_info_required);
      :发送通知给用户 (要求补充资料);
      stop
    else (否 - 直接拒绝)
      :选择"拒绝";
      :填写拒绝原因;
    endif
  endif
}

|系统核心处理|
if (管理员操作是"批准"?) then (是)
  :更新用户状态 (status: approved, is_active: true);
  :发送"账户已批准"通知给用户;
  :记录审核日志 (AuditLog);
else (若是"拒绝")
  :更新用户状态 (status: rejected);
  :发送"账户被拒绝"通知给用户 (附原因);
  :记录审核日志 (AuditLog);
endif

|用户|
:收到审核结果通知;
if (已批准?) then (是)
  :登录并使用系统功能;
else (否)
  : (根据通知进行相应操作);
endif
stop
@enduml
```

### 7.2 广告创建与发布流程 (带泳道)

```plantuml
@startuml CreateAdActivitySwimlanes
title Advertisement Creation and Publishing Process (Swimlanes)
|广告主|
start
:登录系统;
:导航至"广告管理";
if (选择已有广告活动?) then (是)
  :选择一个"进行中"或"草稿"的广告活动;
else (否，创建新活动)
  :点击"创建新广告活动";
  :填写活动信息 (名称, 预算, 时间等);
  :提交活动创建;
  |系统|
  :校验活动数据;
  if (活动数据有效?) then (是)
    :创建 Campaign 记录 (status: draft/pending_approval);
    |广告主|
    :接收"活动创建成功"提示;
  else (否)
    |广告主|
    :接收错误提示，修改活动信息;
    stop
  endif
endif
:在选定/新建的活动下点击"创建新广告";
:填写广告详情 (名称, 选择广告位, 日预算, 目标URL, 投放时段等);
:上传广告素材 (图片/视频/文本);
:预览广告效果 (可选);
:提交广告;

|系统|
:校验广告数据与素材;
if (广告数据有效 且 活动预算充足/广告预算设置合理 且 素材合规?) then (是)
  :创建 Ad 记录 (status: pending_approval);
  :关联 Ad 到 Campaign 和 AdPlacement;
  :保存素材文件;
  :通知管理员新广告待审核;
  |广告主|
  :接收"广告提交成功，等待审核"提示;
else (否)
  |广告主|
  :接收错误提示 (如预算不足, 素材格式错误, 信息不全等);
  :修改广告信息或素材;
  stop
endif

|管理员|
partition "广告审核" {
  :登录系统;
  :访问"广告审核"模块;
  :查看待审核广告列表 (含广告详情、素材预览);
  :选择广告进行审核;
  :检查广告内容、素材合规性、目标链接安全性及设置;
  if (批准广告?) then (是)
    :选择"批准";
    :可添加备注;
  else (否 - 拒绝)
    :选择"拒绝";
    :填写明确的拒绝原因;
  endif
}

|系统|
if (管理员操作是"批准"?) then (是)
  :更新 Ad status 为 "active";
  :创建 AuditLog (entity_type='Ad', action: approve);
  :通知广告主广告已批准;
  :根据投放时间自动开始投放广告;
  |广告主|
  :收到广告批准通知;
  :广告按计划开始投放;
else (若是"拒绝")
  :更新 Ad status 为 "rejected";
  :创建 AuditLog (entity_type='Ad', action: reject, reason);
  :通知广告主广告被拒绝 (附带原因);
  |广告主|
  :收到广告拒绝通知;
  :可根据原因修改广告后重新提交;
endif
stop
@enduml
```

### 7.3 发票申请与处理流程 (带泳道)

```plantuml
@startuml InvoiceRequestActivitySwimlanes
title Invoice Application Process
skinparam monochrome true ' 取消颜色定义，避免兼容性问题

|广告主|
start
:登录系统;
:进入财务管理-发票管理;
:查看可开票金额;
if (需要管理抬头?) then (是)
  :进入抬头管理;
  |系统|
  :保存抬头数据;
  |广告主|
  :返回申请页面;
endif
:点击申请新发票;
:选择发票抬头;
:填写申请信息;
:选择关联交易;
:提交申请;

|系统|
:校验申请数据;
if (数据有效?) then (是)
  :创建发票记录;
  :通知管理员;
  |广告主|
  :收到待处理提示;
else (否)
  |广告主|
  :收到错误提示;
  :修改信息;
  stop
endif

|管理员|
:登录系统;
:进入发票审批;
:查看待处理列表;
:选择发票处理;
:审核合规性;
if (批准?) then (是)
  :标记批准;
  :添加备注;
else (否)
  :标记拒绝;
  :填写原因;
endif

|系统|
if (操作是批准?) then (是: 批准)
  :更新状态为处理中;
  :通知用户;
  |财务人员|
  :执行开票操作;
  :录入发票信息;
  :标记为已完成;
  |系统|
  :更新状态为completed;
  if (是电子发票?) then (电子发票)
    :发送电子发票;
  elseif (是纸质发票?) then (纸质发票)
    :记录邮寄信息;
  else (其他/通知完成)
    :通知已完成;
  endif
else (是: 拒绝)
  :更新状态为rejected;
  :通知用户;
endif

|用户|
:收到处理结果;
if (收到电子发票?) then (是: 电子发票)
  :下载发票;
elseif (收到邮寄通知?) then (是: 邮寄通知)
  :等待发票;
endif
stop
@enduml
```

## 8. 系统架构

### 8.1 MVT (Model-View-Template) 架构图

AdWeb 平台后端采用 Django 框架，遵循 MVT (Model-View-Template) 设计模式。

```plantuml
@startuml MVTArchitectureEnhanced
title AdWeb - MVT (Model-View-Template) Architecture

skinparam packageStyle rect
skinparam componentStyle rectangle  ' 统一组件样式

package "Client-Side" {
  [Web Browser\n(HTML/CSS/JavaScript)] <<Browser>> as UI
}

package "Network Layer" {
  [HTTP Request] <<Data>> as HTTP_Request
  [HTTP Response] <<Data>> as HTTP_Response
}

package "Web Server\n(Gunicorn + Nginx)" {
  [Reverse Proxy\n(Nginx)] <<Component>> as Nginx
  [WSGI Server\n(Gunicorn)] <<Component>> as Gunicorn
}

package "Django Framework\n(AdWeb Backend)" {
  folder "Request/Response Handling" {
    [Middleware Pipeline] <<Filters>> as Middleware
  }
  folder "Application Logic" {
    [Views\n(views.py)] <<Controller>> as Views
    [Forms\n(forms.py)] <<Validator>> as Forms
  }
  folder "Data Management" {
    [Models\n(models.py)] <<ORM>> as Models
    [Database API] <<DAL>> as DB_API
  }
  folder "Presentation" {
    [Templates\n(HTML/DTL)] <<Renderer>> as Templates
    [Template Engine] <<Processor>> as TemplateEngine
  }
  folder "Static & Media" {
    [Static Files\n(CSS/JS/Images)] <<Asset>> as StaticStorage
    [Media Files\n(User Uploads)] <<Asset>> as MediaStorage
  }
}

package "Data Persistence" {
  database "Database\n(PostgreSQL/MySQL)" {
    [DB Schema & Tables] as DB_Schema
  }
}

package "External Services" {
  [Payment Gateway] <<API>> as PaymentAPI
  [Ad Network] <<API>> as AdNetworkAPI
  [Email Service] <<API>> as EmailAPI
}

' 流程连接
UI -> HTTP_Request : 用户交互
HTTP_Request -> Nginx : 接收请求
Nginx -> Gunicorn : 转发至 WSGI
Gunicorn -> Middleware : 传递至 Django
Middleware -> URLs : 中间件处理
URLs -> Views : 路由至视图
Views -> Forms : （可选）验证输入
Forms --> Views : 返回清洗数据/错误
Views -> Models : 数据 CRUD 操作
Models -> DB_API : 调用数据库 API
DB_API -> DB_Schema : 执行 SQL 查询
DB_Schema --> DB_API : 返回查询结果
DB_API --> Models : 返回数据对象
Models --> Views : 提供数据
Views -> TemplateEngine : 选择模板 + 上下文
TemplateEngine -> Templates : 渲染模板
Templates --> TemplateEngine : 生成 HTML
TemplateEngine --> Views : 返回渲染结果
Views -> Middleware : 处理响应
Middleware -> HTTP_Response : 构建响应
HTTP_Response -> Gunicorn
Gunicorn -> Nginx
Nginx -> UI : 响应至浏览器

' 静态/媒体文件优化
Nginx --> StaticStorage : 直接服务静态文件
Nginx --> MediaStorage : 直接服务媒体文件

' 外部服务交互
Views --> PaymentAPI : 充值操作
Views --> AdNetworkAPI : 广告数据
Views --> EmailAPI : 通知发送
@enduml
```

**架构说明:**
AdWeb 平台后端采用 Django 框架，遵循 MVT (Model-View-Template) 设计模式，这与常见的 MVC (Model-View-Controller) 模式类似，但有一些 Django 特有的称谓和职责划分：

*   **Model (模型 - `models.py`)**:
    *   负责应用程序的数据结构和业务逻辑。
    *   直接与数据库交互（通过 Django ORM），执行数据的创建 (Create)、读取 (Read)、更新 (Update) 和删除 (Delete) 操作。
    *   定义数据字段、类型、验证规则、关系等。
    *   例如，`User`, `Campaign`, `Ad`, `Invoice` 等都是模型。

*   **View (视图 - `views.py`)**:
    *   负责处理用户的 HTTP 请求并返回 HTTP 响应。
    *   接收请求后，视图函数或类会执行相应的逻辑：
        *   可能与一个或多个模型交互以获取或存储数据。
        *   可能使用 Django Forms (`forms.py`) 来处理用户输入数据的验证。
        *   选择一个合适的模板 (`Templates`) 来渲染响应。
        *   将从模型获取的数据（上下文 context）传递给模板。
    *   Django 中的视图更接近 MVC 中的控制器 (Controller) 的角色。
    *   例如，`Payment/views.py` 中的 `invoice_request` 函数就是一个视图。

*   **Template (模板 - `*.html` files in `templates` directory)**:
    *   负责用户界面的表示层。
    *   是带有特殊标签和过滤器的 HTML 文件，用于动态生成最终的 HTML 内容。
    *   从视图接收数据上下文，并根据这些数据渲染页面。
    *   Django 的模板语言允许嵌入逻辑（如循环、条件判断）和变量替换。
    *   例如，`Payment/invoice.html` 就是一个模板。

*   **URL Dispatcher (`urls.py`)**:
    *   根据请求的 URL 将其路由到相应的视图函数或类。
    *   项目有全局的 `urls.py`，每个 Django 应用 (app) 也可以有自己的 `urls.py`。

*   **Forms (`forms.py`)**:
    *   处理 HTML表单的生成、验证和数据清洗。
    *   可以从模型自动生成表单 (ModelForms)，简化表单处理逻辑。

*   **Middleware**:
    *   在请求处理和响应处理的各个阶段提供钩子，可以修改请求/响应对象或执行特定任务（如会话管理、CSRF保护、认证）。

*   **Static Files & Media Files**:
    *   `Static Files` 指的是项目的 CSS、JavaScript、图片等不常变动的资源，通常由Web服务器（如Nginx）直接提供服务以提高效率。
    *   `Media Files` 通常是用户上传的文件，如广告素材图片，也常由Web服务器直接提供服务。

**交互流程简述:**
1.  用户通过浏览器发起 HTTP 请求。
2.  Web 服务器 (如 Nginx) 接收请求，可能直接处理静态/媒体文件请求，或将动态请求转发给 WSGI 服务器 (如 Gunicorn)。
3.  Gunicorn 将请求传递给 Django 应用。
4.  Django 的 `Middleware` 对请求进行预处理。
5.  `URL Dispatcher` 根据请求的 URL 找到对应的 `View`。
6.  `View` 执行业务逻辑：
    *   可能通过 `Forms` 验证和处理用户输入。
    *   通过 `Models` (Django ORM) 与数据库进行数据交互。
    *   可能调用外部服务API (如支付、邮件)。
7.  `View` 选择一个 `Template`，并将处理好的数据（上下文）传递给 `TemplateEngine`。
8.  `TemplateEngine` 使用模板渲染成最终的 HTML。
9.  `View` 将渲染好的 HTML 包装成 HTTP 响应。
10. `Middleware` 对响应进行后处理。
11. Django 将 HTTP 响应发送回 Gunicorn，再到 Nginx，最终到达用户的浏览器。

这种分层架构有助于代码的组织、可维护性和可重用性。

### 8.2 组件与接口依赖图

```plantuml
@startuml BackendComponentsAndInterfaces
title AdWeb Backend Components
skinparam linetype ortho ' 使用直角连线，使布局更整洁

package "Django应用" {
  component UsersApp as users
  component PaymentApp as payment
  component AdManageApp as ad_manage
  component AdPlaceApp as ad_place
  component AdAuditApp as ad_audit
  component DataShowApp as data_show
}

package "核心服务" {
  component ORM
  component 认证系统 as auth
  component 通知服务 as notify
}

package "外部接口" {
  interface 支付网关 as pay_gateway
  interface 邮件服务 as email
  interface 广告网络 as ad_network
}

' 尝试统一“Django应用”到“核心服务”的连线方向 (例如，都向下指)
users -down-> ORM : 使用
payment -down-> ORM : 使用
ad_manage -down-> ORM : 使用
ad_place -down-> ORM : 使用
ad_audit -down-> ORM : 使用
data_show -down-> ORM : 使用

users -down-> auth : 认证
payment -down-> auth : 登录验证
ad_manage -down-> auth : 登录验证

users .down.> notify : 触发用户通知
payment .down.> notify : 触发支付通知
ad_audit .down.> notify : 触发审核通知
ad_place .down.> notify : 触发广告通知

payment -right-> pay_gateway : 处理充值
users -right-> email : 发送验证邮件
notify .right.> email : 发送各类通知
ad_place -right-> ad_network : 发送广告数据
' data_show <-- ad_network : 接收统计数据  可以改写成下面的形式，更明确指出 ad_network 在 data_show 的右边（如果布局如此）
ad_network -left-> data_show : 接收统计数据

note bottom: 依赖关系基于Django模型关联和服务调用
@enduml
```
**组件与接口依赖说明:**
*   **Django Apps (Components)**: 代表项目中的主要功能模块。
    *   `UsersApp`: 用户账户、认证、授权。
    *   `PaymentApp`: 充值、交易、发票。
    *   `AdManageApp`: 广告活动管理。
    *   `AdPlaceApp`: 广告、广告位管理。
    *   `AdAuditApp`: 广告和用户审核。
    *   `DataShowApp`: 广告数据统计与展示。
*   **Core Django Services**: Django框架提供的核心功能。
    *   `Django ORM`: 所有App都通过ORM与数据库交互。
    *   `Authentication System`: 用于用户登录、权限控制。
    *   `Notification Service`: 一个概念上的服务，用于处理和发送各类通知（可能通过邮件、站内信等）。
*   **External Service Interfaces**: 系统依赖的外部服务。
    *   `PaymentGateway`: 处理支付。
    *   `EmailService`: 发送邮件。
    *   `AdServingNetwork`: 广告的实际投放和数据收集。
*   **Dependencies**:
    *   **ORM Usage**: 所有App都依赖ORM进行数据持久化。
    *   **Auth System Usage**: 大部分App的视图会使用认证系统来保护接口。
    *   **Notification Triggering**: 多个App会触发通知服务。
    *   **External API Calls**: `PaymentApp`调用支付网关，`UsersApp`/`NotificationService` 调用邮件服务，`AdPlaceApp`/`DataShowApp` 与广告网络交互。
    *   **Inter-App Dependencies**:
        *   `PaymentApp` 需要访问 `UsersApp` 获取用户信息和余额。
        *   广告相关的App (`AdManageApp`, `AdPlaceApp`, `AdAuditApp`, `DataShowApp`) 之间存在数据和逻辑依赖，例如广告属于某个活动，广告需要被审核，广告数据需要被统计等。这些通常通过模型的外键关系和视图逻辑实现。

## 9. 场景与交互

### 9.1 表格形式用例交互脚本 (扩展自原场景脚本)

#### 9.1.1 场景：广告主成功发布一个新广告

| 步骤ID | 参与者   | 用户操作/输入                                       | 系统动作/响应                                                                                                                                                           | 数据项/状态变更                                                                                                | 备注/UI元素                                                                                             |
|--------|----------|---------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------|
| S1.1   | 广告主   | 登录系统                                          | 系统验证凭证，创建会话                                                                                                                                                    | 用户会话建立                                                                                                | 登录表单                                                                                                   |
| S1.2   | 广告主   | 导航到"广告管理"页面，选择或创建广告活动，点击"创建新广告" | 系统显示创建广告表单                                                                                                                                                    | 活动ID被选定                                                                                                | "广告活动列表"，"创建广告活动"按钮，"创建广告"按钮                                                              |
| S1.3   | 广告主   | 填写广告表单：名称, 广告位, 预算, 投放时段, 素材, 目标URL | (前端校验)                                                                                                                                                              | 表单数据暂存                                                                                                | 广告名称输入框, 广告位选择器, 预算输入框, 日期选择器, 素材上传控件, URL输入框                               |
| S1.4   | 广告主   | 点击"提交审核"                                      | 系统后端校验表单数据 (有效性, 预算是否超限等)                                                                                                                               |                                                                                                                 | "提交审核"按钮                                                                                             |
| S1.5   | 系统     | 数据校验通过                                      | 将广告数据存入数据库 (Ad模型)，设置广告状态为"pending_approval"，关联到Campaign和AdPlacement，保存素材。生成通知给管理员。                                                          | `Ad.status` = 'pending_approval', 新增Ad记录, 新增AuditLog (可选, 初始提交), 新增Notification (给管理员)       |                                                                                                          |
| S1.6   | 系统     |                                                   | 向广告主显示"广告提交成功，等待管理员审核"的提示。                                                                                                                            |                                                                                                                 | 成功消息提示框                                                                                             |
| S1.7   | 管理员   | 登录系统，进入"广告审核"模块                         | 系统显示待审核广告列表                                                                                                                                                    |                                                                                                                 | "广告审核"菜单，待审核列表                                                                                    |
| S1.8   | 管理员   | 选择S1.5中提交的广告，查看详情和素材                  | 系统展示广告详细信息和素材预览                                                                                                                                              |                                                                                                                 | 广告详情页                                                                                                 |
| S1.9   | 管理员   | 认为广告合规，点击"批准" (可附备注)                   | 系统更新广告状态为"active"，记录审核日志 (AuditLog)，生成通知给广告主。                                                                                                       | `Ad.status` = 'active', 更新AuditLog (action='approve'), 新增Notification (给广告主)                      | "批准"按钮, 备注输入框                                                                                       |
| S1.10  | 系统     |                                                   | 向广告主发送通知，告知广告已通过审核。根据投放设置，广告开始投放。                                                                                                              |                                                                                                                 | 广告主消息中心/邮件                                                                                          |
| *Ext1* | 系统     | S1.4 数据校验失败                                   | 系统在表单旁显示具体错误信息。                                                                                                                                              |                                                                                                                 | 错误消息提示                                                                                                 |
| *Ext2* | 管理员   | S1.9 认为广告不合规，点击"拒绝"，填写拒绝原因         | 系统更新广告状态为"rejected"，记录审核日志及拒绝原因 (AuditLog)，生成通知给广告主。                                                                                             | `Ad.status` = 'rejected', 更新AuditLog (action='reject', reason), 新增Notification (给广告主, 含原因) | "拒绝"按钮, 拒绝原因输入框                                                                                   |

#### 9.1.2 场景：用户成功申请并发票被开具

| 步骤ID | 参与者   | 用户操作/输入                                              | 系统动作/响应                                                                                                                                                                                                                            | 数据项/状态变更                                                                                                                                        | 备注/UI元素                                                                                                            |
|--------|----------|------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| S2.1   | 广告主   | 登录系统，导航到"财务管理" -> "发票管理"                     | 系统显示可开票金额、历史发票列表、发票抬头管理入口。                                                                                                                                                                                                 |                                                                                                                                                          | "发票管理"菜单                                                                                                       |
| S2.2   | 广告主   | 点击"申请新发票"                                           | 系统显示发票申请表单，允许选择发票抬头、填写金额、邮箱等。                                                                                                                                                                                             |                                                                                                                                                          | "申请新发票"按钮, 发票抬头选择器, 金额输入框, 邮箱输入框                                                                     |
| S2.3   | 广告主   | 选择/确认发票抬头，填写申请金额，选择关联交易，提交申请        | (前端校验)                                                                                                                                                                                                                               | 表单数据暂存                                                                                                                                             |                                                                                                                      |
| S2.4   | 系统     | 后端校验数据 (金额是否超限, 抬头有效性, 交易可选性等)         |                                                                                                                                                                                                                                        |                                                                                                                                                          |                                                                                                                      |
| S2.5   | 系统     | 数据校验通过                                               | 创建Invoice记录 (status='pending')，创建InvoiceItem记录关联Transaction。通知管理员。                                                                                                                                                         | `Invoice.status`='pending', 新增Invoice记录, 新增InvoiceItem记录, 新增Notification (给管理员)                                                          |                                                                                                                      |
| S2.6   | 系统     |                                                            | 向广告主显示"发票申请已提交，等待处理"提示。                                                                                                                                                                                                 |                                                                                                                                                          | 成功消息提示框                                                                                                       |
| S2.7   | 管理员   | 登录系统，进入"发票审批"模块                                 | 系统显示待处理发票列表。                                                                                                                                                                                                                             |                                                                                                                                                          | "发票审批"菜单                                                                                                       |
| S2.8   | 管理员   | 选择S2.5中提交的发票申请，查看详情                           | 系统展示发票申请详情和关联交易。                                                                                                                                                                                                                     |                                                                                                                                                          | 发票详情页                                                                                                           |
| S2.9   | 管理员   | 确认信息无误，点击"批准处理"                                 | 系统更新Invoice状态为"processing"，通知广告主。                                                                                                                                                                                                   | `Invoice.status`='processing', 新增Notification (给广告主)                                                                                             | "批准处理"按钮                                                                                                       |
| S2.10  | 管理员   | (线下或通过开票系统)完成实际开票，在系统中更新发票信息并标记完成 | 系统更新Invoice状态为"completed"，保存发票号、日期、PDF链接(电子)/快递信息(纸质)。通知广告主。                                                                                                                                                     | `Invoice.status`='completed', `Invoice.invoice_number`, `Invoice.invoice_date`, `Invoice.pdf_url`等更新, 新增Notification (给广告主) | "标记完成"按钮, 发票号输入框, 日期选择器, PDF上传/快递信息输入                                                               |
| *Ext3* | 系统     | S2.4 数据校验失败                                            | 系统在表单旁显示具体错误信息。                                                                                                                                                                                                                         |                                                                                                                                                          | 错误消息提示                                                                                                         |
| *Ext4* | 管理员   | S2.9 审核发现问题，点击"拒绝"，填写原因                      | 系统更新Invoice状态为"rejected"，记录管理员备注，通知广告主。                                                                                                                                                                                             | `Invoice.status`='rejected', `Invoice.admin_remark`更新, 新增Notification (给广告主, 含原因)                                                           | "拒绝"按钮, 备注输入框                                                                                                 |
| *Ext5* | 广告主   | S2.1 (可选)管理发票抬头：新增/修改/设置默认发票抬头        | 系统保存InvoiceInfo数据。                                                                                                                                                                                                                            | 新增/更新InvoiceInfo记录                                                                                                                                 | "发票抬头管理"页面                                                                                                     |

### 9.2 CRC 卡片 (Class-Responsibility-Collaboration) - 表格形式

| 类名 (Class)                 | 核心职责 (Responsibilities)                                                                                                                                                                                                                         | 主要协作者 (Collaborators)                                                                                                                                                                                                                                                                                          |
|------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **`User` (用户)**             | - 管理用户认证信息 (注册, 登录, 密码哈希, 会话)。 <br> - 维护用户基本资料和权限 (`is_staff`, `is_superuser`, `user_type`)。 <br> - 管理特定类型用户的属性 (广告主余额 `balance`, 审核状态 `audit_status`)。 <br> - 接收通知。                                                               | `ValidationCode` (验证操作), `Notification` (接收通知), `AuthSys` (认证授权), `Transaction` (余额变动), `InvoiceInfo` (发票抬头), `Invoice` (发票申请), `Campaign`/`Ad` (作为广告主创建), `AuditLog` (作为管理员审核)                                                              |
| **`Campaign` (广告活动)**   | - 定义活动属性 (名称, 预算, 时间, 状态)。 <br> - 管理活动生命周期状态 (`CampaignStatusEnum`)。 <br> - 聚合其下的广告 (`Ad`)。 <br> - 计算预算消耗。                                                                                                       | `User` (Advertiser), `Ad` (包含的广告), `Transaction` (通过Ad花费影响预算), `DailyStats` (活动级别统计)                                                                                                                                                                                 |
| **`Ad` (广告)**               | - 定义广告属性 (名称, 素材, 链接, 预算, 时间, 状态)。 <br> - 管理广告生命周期状态 (`AdStatusEnum`)。 <br> - 关联到 `Campaign` 和 `AdPlacement`。 <br> - 被审核 (记录到`AuditLog`)。 <br> - 跟踪投放数据 (展示`AdImpression`, 点击`AdClick`)。                    | `User` (Advertiser), `Campaign`, `AdPlacement`, `AuditLog`, `Transaction` (广告花费), `AdImpression`, `AdClick`, `DailyStats` (广告级别统计)                                                                                                                                       |
| **`AdPlacement` (广告位)**  | - 定义广告位属性 (名称, 类型, 尺寸, 价格模型)。 <br> - 管理广告位的可用状态 (`is_active`)。                                                                                                                                                              | `Ad` (承载的广告)                                                                                                                                                                                                                                                                   |
| **`Transaction` (交易记录)**| - 记录资金变动 (类型, 金额, 支付方式, 状态)。 <br> - 关联到用户, 可选关联广告或发票。 <br> - 管理交易生命周期状态 (`TransactionStatusEnum`)。                                                                                                                 | `User` (交易主体), `Ad` (广告花费关联), `Invoice` (发票支付/退款关联), `InvoiceItem` (被发票项目包含), `PaymentGateway` (外部支付处理), `Notification` (交易状态通知)                                                                                                           |
| **`InvoiceInfo` (发票抬头)**| - 存储用户配置的发票抬头完整信息。 <br> - 标记是否为默认抬头。                                                                                                                                                                                            | `User` (拥有者), `Invoice` (被发票申请使用)                                                                                                                                                                                                                                               |
| **`Invoice` (发票申请)**    | - 记录发票申请详情 (抬头, 类型, 金额, 内容, 状态)。 <br> - 管理发票生命周期状态 (`InvoiceStatusEnum`)。 <br> - 聚合发票项目 (`InvoiceItem`)。 <br> - 记录开票后的信息 (票号, 日期, PDF等)。                                                                    | `User` (申请人), `InvoiceInfo` (发票抬头), `InvoiceItem` (发票明细), `Transaction` (通过InvoiceItem关联), `Notification` (发票状态通知)                                                                                                                                        |
| **`InvoiceItem` (发票项目)**| - 将一笔或多笔交易的金额分配到一张发票中。                                                                                                                                                                                                              | `Invoice` (所属发票), `Transaction` (关联的交易)                                                                                                                                                                                                                                          |
| **`AuditLog` (审核日志)**   | - 记录对特定实体 (广告, 用户等) 的审核操作。 <br> - 包含审核人, 操作类型, 时间, 状态变更, 原因。                                                                                                                                                           | `Ad` (被审核实体), `User` (被审核实体 或 执行审核的管理员)                                                                                                                                                                                                                            |
| **`AdImpression` (展示)**  | - 记录单次广告展示事件的详细信息。 <br> - 可能触发CPM计费。                                                                                                                                                                                            | `Ad` (被展示的广告), `AdClick` (可能后续产生), `DailyStats` (被汇总)                                                                                                                                                                                                                 |
| **`AdClick` (点击)**        | - 记录单次广告点击事件的详细信息。 <br> - 可能触发CPC计费。 <br> - 可关联到对应的展示。                                                                                                                                                                | `Ad` (被点击的广告), `AdImpression` (关联的展示), `DailyStats` (被汇总)                                                                                                                                                                                                                 |
| **`DailyStats` (每日统计)** | - 按天聚合指定层级 (广告/活动/广告主/平台) 的核心指标 (展示, 点击, 花费)。 <br> - 计算并存储衍生指标 (CTR, CPC, CPM)。                                                                                                                                     | `Ad`, `Campaign`, `User` (Advertiser), `AdImpression`, `AdClick` (原始数据来源)                                                                                                                                                                                                  |
| **`Notification` (通知)**   | - 创建和存储各类系统和业务通知。 <br> - 管理通知的已读/未读状态。 <br> - 关联接收用户和可选的触发源/链接。                                                                                                                                                    | `User` (接收者/触发者), `Invoice`, `Ad`, `Transaction`, `Campaign` (通知内容可能相关的源对象)                                                                                                                                                                               |
| **`ValidationCode` (验证码)**| - 生成、存储和验证一次性验证码。 <br> - 管理验证码的有效期和使用状态。                                                                                                                                                                                      | `User` (关联用户), `EmailService` (发送验证码邮件)                                                                                                                                                                                                                              |

### 9.3 关键交互顺序图示例

#### 9.3.1 广告主充值账户 (以余额支付为例)

```plantuml
@startuml RechargeBalanceSequence
title Sequence Diagram: Advertiser Recharges Account (Balance Payment)

actor Advertiser
participant "Browser" as WebBrowser
participant "Django View (recharge_view)" as RechargeView
participant "Transaction Model" as TransactionModel
participant "User Model (Advertiser)" as UserModel
participant "Notification Service" as NotifyService
database "Database" as DB

Advertiser -> WebBrowser: 1. 访问充值页面, 输入充值金额 (e.g., 100), 选择"余额支付"
WebBrowser -> RechargeView: 2. POST /payment/recharge/ (amount=100, payment_method='balance')

activate RechargeView
RechargeView -> RechargeView: 3. 校验充值金额 (e.g., > 0)
alt 金额无效
    RechargeView --> WebBrowser: 4a. 返回错误信息
    WebBrowser --> Advertiser: 4b. 显示错误
else 金额有效
    RechargeView -> TransactionModel: 5. create(user=advertiser, amount=100, type='recharge', method='balance', status='pending')
    activate TransactionModel
    TransactionModel -> DB: 6. 创建 Transaction 记录 (status: pending)
    DB --> TransactionModel: 7. 返回 Transaction 实例 (tx_pending)
    TransactionModel --> RechargeView: 8. tx_pending
    deactivate TransactionModel

    RechargeView -> UserModel: 9. get(user=advertiser)
    activate UserModel
    UserModel -> DB: 10. 获取 Advertiser 用户对象
    DB --> UserModel: 11. Advertiser 对象 (current_balance)
    UserModel --> RechargeView: 12.
    deactivate UserModel

    RechargeView -> UserModel: 13. advertiser.balance += 100; advertiser.save()
    activate UserModel
    UserModel -> DB: 14. 更新用户余额
    DB --> UserModel: 15.
    deactivate UserModel

    RechargeView -> TransactionModel: 16. tx_pending.status = 'completed'; tx_pending.save()
    activate TransactionModel
    TransactionModel -> DB: 17. 更新 Transaction 状态为 'completed'
    DB --> TransactionModel: 18.
    TransactionModel --> RechargeView: 19.
    deactivate TransactionModel

    RechargeView -> NotifyService: 20. send_recharge_success_notification(advertiser, 100, tx_pending.id)
    activate NotifyService
    NotifyService -> DB: 21. 创建 Notification 记录
    DB --> NotifyService: 22.
    NotifyService --> EmailService: 23. (可选) 发送充值成功邮件
    deactivate NotifyService

    RechargeView --> WebBrowser: 24. 重定向到余额页面 / 返回成功信息
    WebBrowser --> Advertiser: 25. 显示“充值成功 ¥100”
end
deactivate RechargeView
@enduml
```

#### 9.3.2 广告投放与数据收集 (简化流程)

```plantuml
@startuml AdServingAndDataCollectionSequence
title 广告投放与数据收集序列图

' 移除所有非必要参数（autonumber、skinparam等）
' 仅保留基础序列图元素

actor Viewer as "终端用户"
participant Publisher as "发布商平台"
participant AdServing as "广告投放引擎"
participant AdModel as "广告模型"
participant Impression as "展示记录模型"
participant Click as "点击记录模型"
participant Stats as "统计服务"
database DB as "广告数据库"

Viewer -> Publisher: 访问页面（触发广告请求）
Publisher -> AdServing: 请求广告(位置ID, 用户上下文)
AdServing -> AdModel: 查找合适广告
AdModel -> DB: 查询有效广告
DB --> AdModel: 返回广告列表
AdModel --> AdServing: 选中广告
AdServing --> Publisher: 返回广告素材
Publisher --> Viewer: 展示广告
AdServing -> Impression: 记录展示
Impression -> DB: 创建展示记录
DB --> Impression: 
AdServing -> Stats: 增加展示计数

alt 用户点击广告
    Viewer -> Publisher: 点击广告
    Publisher -> AdServing: 上报点击事件
    AdServing -> Click: 记录点击
    Click -> DB: 创建点击记录
    DB --> Click: 
    AdServing -> Stats: 增加点击计数
    AdServing -> Viewer: 重定向到目标URL
end

Stats -> DB: 更新统计数据
@enduml
```

## 10. 项目接口设计

本节描述 AdWeb 平台后端对外及内部关键接口的设计。

### 10.1 主要API端点 (RESTful风格 - 示例)

| HTTP方法 | 端点路径                         | 控制器/视图 (App.View)       | 描述                                     | 主要请求体 (示例)                                  | 主要响应体 (示例)                                                | 权限         |
|----------|----------------------------------|------------------------------|------------------------------------------|---------------------------------------------------|------------------------------------------------------------------|--------------|
| POST     | `/api/users/register/`           | `UsersApp.register_user`     | 用户注册                                 | `{username, email, password}`                     | `{user_id, username, email, message}`                            | 公开         |
| POST     | `/api/users/login/`              | `UsersApp.login_user`        | 用户登录                                 | `{username, password}`                            | `{token, user_id, username}`                                     | 公开         |
| GET      | `/api/users/profile/`            | `UsersApp.user_profile`      | 获取当前用户信息                         | -                                                 | `{user_id, username, email, balance, company, ...}`              | 广告主/管理员 |
| PUT      | `/api/users/profile/`            | `UsersApp.update_profile`    | 更新用户信息                             | `{company, phone, ...}`                           | `{user_id, username, ..., message}`                              | 广告主/管理员 |
| GET      | `/api/campaigns/`                | `AdManageApp.list_campaigns` | 获取广告活动列表                         | -                                                 | `[{id, name, status, budget, ...}, ...]`                         | 广告主/管理员 |
| POST     | `/api/campaigns/`                | `AdManageApp.create_campaign`| 创建广告活动                             | `{name, budget, start_date, end_date}`            | `{id, name, status, ..., message}`                               | 广告主       |
| GET      | `/api/campaigns/{id}/`           | `AdManageApp.campaign_detail`| 获取特定广告活动详情                     | -                                                 | `{id, name, status, ads:[...], ...}`                             | 广告主/管理员 |
| PUT      | `/api/campaigns/{id}/`           | `AdManageApp.update_campaign`| 更新广告活动                             | `{name?, budget?, status?}`                       | `{id, name, status, ..., message}`                               | 广告主       |
| GET      | `/api/ads/`                      | `AdPlaceApp.list_ads`        | 获取广告列表 (可带过滤参数)              | `?campaign_id={id}&status={status}`               | `[{id, name, status, campaign_id, ...}, ...]`                    | 广告主/管理员 |
| POST     | `/api/ads/`                      | `AdPlaceApp.create_ad`       | 创建广告                                 | `{campaign_id, placement_id, name, creative, ...}`| `{id, name, status, ..., message}`                               | 广告主       |
| POST     | `/api/ads/{id}/submit_audit/`    | `AdPlaceApp.submit_ad_audit` | 提交广告审核                             | -                                                 | `{message}`                                                      | 广告主       |
| GET      | `/api/admin/ads/pending_audit/`  | `AdAuditApp.pending_ads`     | (管理员)获取待审核广告列表             | -                                                 | `[{id, name, advertiser_info, ...}, ...]`                        | 管理员       |
| POST     | `/api/admin/ads/{id}/approve/`   | `AdAuditApp.approve_ad`      | (管理员)批准广告                         | `{remark?}`                                       | `{message}`                                                      | 管理员       |
| POST     | `/api/admin/ads/{id}/reject/`    | `AdAuditApp.reject_ad`       | (管理员)拒绝广告                         | `{reason, remark?}`                               | `{message}`                                                      | 管理员       |
| POST     | `/api/payment/recharge/`         | `PaymentApp.recharge`        | 账户充值                                 | `{amount, payment_method}`                        | `{transaction_id, status, message}`                            | 广告主       |
| GET      | `/api/payment/transactions/`     | `PaymentApp.list_transactions`| 获取交易记录                             | `?type={type}&date_from={date}`                   | `[{id, amount, type, status, created_at, ...}, ...]`             | 广告主/管理员 |
| POST     | `/api/payment/invoices/request/` | `PaymentApp.request_invoice` | 申请发票                                 | `{invoice_info_id, amount, items:[{tx_id, amt}]}` | `{invoice_id, status, message}`                                  | 广告主       |
| GET      | `/api/payment/invoices/`         | `PaymentApp.list_invoices`   | 获取发票列表                             | `?status={status}`                                | `[{id, amount, status, invoice_number, ...}, ...]`               | 广告主/管理员 |
| POST     | `/api/admin/invoices/{id}/process/`| `PaymentApp.process_invoice`| (管理员)处理发票 (批准/拒绝/完成)      | `{action, remark?, invoice_number?}`              | `{message}`                                                      | 管理员       |
| GET      | `/api/stats/advertiser/summary/` | `DataShowApp.advertiser_summary`| (广告主)获取其广告数据概览             | `?date_range={range}`                             | `{total_spent, total_impressions, total_clicks, ctr, ...}`       | 广告主       |
| GET      | `/api/stats/admin/platform/`     | `DataShowApp.platform_stats` | (管理员)获取平台整体数据                 | `?date_range={range}`                             | `{total_revenue, active_users, total_ads, ...}`                  | 管理员       |

### 10.2 关键内部接口/服务调用 (概念性)

除了对外API，系统内部模块间也存在调用（通过Python函数/方法调用，或Django Signals等机制）。

*   **`NotificationService.send(recipient, title, content, type, related_obj)`**:
    *   **调用者**: `UsersApp` (用户注册/审核后), `PaymentApp` (交易/发票状态变更后), `AdAuditApp` (审核结果后), `AdPlaceApp` (广告状态变更)等。
    *   **功能**: 创建并可能发送通知 (站内信, 邮件)。
*   **`UserService.update_balance(user, amount_delta, transaction_obj)`**:
    *   **调用者**: `PaymentApp` (充值成功后, 广告花费扣款时)。
    *   **功能**: 安全地更新用户余额，并关联交易。
*   **`AdStatusService.change_ad_status(ad, new_status, actor, reason)`**:
    *   **调用者**: `AdAuditApp` (审核操作), `AdPlaceApp` (用户操作暂停/启动), 定时任务 (预算耗尽/到期)。
    *   **功能**: 改变广告状态，记录日志，触发相关通知和副作用 (如更新Campaign统计)。
*   **`DailyStatsAggregator.run_aggregation(date)`**:
    *   **调用者**: 定时任务 (如每日凌晨执行)。
    *   **功能**: 从 `AdImpression` 和 `AdClick` 表收集原始数据，聚合生成 `DailyStats`。

### 10.3 接口与组件依赖图 (PlantUML)

```plantuml
@startuml BackendComponentsAndInterfaces
title AdWeb Backend Components
skinparam linetype ortho ' 使用直角连线，使布局更整洁

package "Django应用" {
  component UsersApp as users
  component PaymentApp as payment
  component AdManageApp as ad_manage
  component AdPlaceApp as ad_place
  component AdAuditApp as ad_audit
  component DataShowApp as data_show
}

package "核心服务" {
  component ORM
  component 认证系统 as auth
  component 通知服务 as notify
}

package "外部接口" {
  interface 支付网关 as pay_gateway
  interface 邮件服务 as email
  interface 广告网络 as ad_network
}

' 尝试统一“Django应用”到“核心服务”的连线方向 (例如，都向下指)
users -down-> ORM : 使用
payment -down-> ORM : 使用
ad_manage -down-> ORM : 使用
ad_place -down-> ORM : 使用
ad_audit -down-> ORM : 使用
data_show -down-> ORM : 使用

users -down-> auth : 认证
payment -down-> auth : 登录验证
ad_manage -down-> auth : 登录验证

users .down.> notify : 触发用户通知
payment .down.> notify : 触发支付通知
ad_audit .down.> notify : 触发审核通知
ad_place .down.> notify : 触发广告通知

payment -right-> pay_gateway : 处理充值
users -right-> email : 发送验证邮件
notify .right.> email : 发送各类通知
ad_place -right-> ad_network : 发送广告数据
' data_show <-- ad_network : 接收统计数据  可以改写成下面的形式，更明确指出 ad_network 在 data_show 的右边（如果布局如此）
ad_network -left-> data_show : 接收统计数据

note bottom: 依赖关系基于Django模型关联和服务调用
@enduml
```


